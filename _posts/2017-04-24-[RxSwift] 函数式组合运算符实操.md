---
layout: post
title: RxSwift å‡½æ•°å¼ç»„åˆè¿ç®—ç¬¦å®æ“
date: 2017.04.24 14:51
tag: ç§»åŠ¨å¼€å‘
---

> ä¸Šå‘¨æˆ‘ä»¬å¼€å¯äº†RxSwiftçš„å­¦ä¹ ä¹‹æ—…, ä»å¯è§‚å¯Ÿåºåˆ—-->è¿‡æ»¤è¿ç®—ç¬¦-->æ˜ å°„è¿ç®—ç¬¦, æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´è¯´ç»„åˆè¿ç®—ç¬¦. è¯´å®è¯, å¯¹äºä¹‹å‰çš„å†…å®¹çš„å­¦ä¹ , æˆ‘è§‰å¾—è¿˜æ˜¯æ¯”è¾ƒé€šä¿—æ˜“æ‡‚çš„, ä½†æ˜¯è¿™æ¬¡çš„ç»„åˆè¿ç®—ç¬¦ç›¸æ¯”ä¹‹å‰åœ¨ç†è§£éš¾æ˜“ç¨‹åº¦ä¸Šåˆä¸Šäº†ä¸ªæ¡£æ¬¡, æœ¬èŠ‚æˆ‘ä»¬å°±æ¥æ”»å…‹è¿™ä¸€æŒ‘æˆ˜å§! ä»£ç è§:[github](https://github.com/coderZsq/coderZsq.target.swift)

![](http://upload-images.jianshu.io/upload_images/1229762-a67b7f2ab21d4b23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬èŠ‚æ‰€éœ€çš„ä¸€äº›å…³äºç»„åˆçš„åŸºæœ¬çŸ¥è¯†å·²ç»æ›´æ–°åˆ°[github](https://github.com/coderZsq/coderZsq.target.swift)ä»£ç ä¸­çš„playgroundæ–‡ä»¶ä¸­, æ²¡æœ‰æ¥è§¦è¿‡å“åº”å¼ç¼–ç¨‹çš„åŒå­¦è¯·å’Œä¹‹å‰ä¸€æ ·å…ˆè¡Œåœ¨[playground](https://github.com/coderZsq/coderZsq.target.swift/blob/master/Our%20Planet/Our%20Planet.playground/Contents.swift)ä¸­äº†è§£æ¦‚è¦ä»¥ä¾¿æ›´å¥½çš„ç†è§£æœ¬æ–‡. æœ¬èŠ‚æˆ‘ä»¬å°±é€šè¿‡æ¡ˆä¾‹é€æ­¥ç²¾è®²ç»„åˆæ“ä½œç¬¦åœ¨å®é™…å¼€å‘æ—¶çš„ä½œç”¨.

è¿™æ¬¡çš„UIå±‚é¢ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¤æ‚, ä¸€ä¸ªTableViewçš„åˆ—è¡¨é¡µå’Œä¸€ä¸ªæœ‰Slideræ§åˆ¶çš„TableViewåˆ—è¡¨é¡µ: 
![](http://upload-images.jianshu.io/upload_images/1229762-821df01cb8ecc097.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬ç« æ˜¯å¯¹äº[RxSwift å“åº”å¼ç¼–ç¨‹å®æˆ˜ æ˜ å°„è¿ç®—ç¬¦](http://www.jianshu.com/p/6b80a0db56bd)è¿›è¡Œå‡çº§çš„ä¸€èŠ‚, æ‰€ä»¥æˆ‘ä»¬æ¥ç€ç½‘ç»œè¯·æ±‚è¿™å—è®²èµ·, æˆ‘ä»¬å…ˆå°†æ¨¡å‹ç±»(`EOCategory` ` EOError` ` EOLocation` ` EOEvent`)æ·»åŠ åˆ°å·¥ç¨‹ä¸­. 
```   
    fileprivate static let API = "https://eonet.sci.gsfc.nasa.gov/api/v2.1"
    static let categoriesEndpoint = "/categories"
    fileprivate static let eventsEndpoint = "/events"
```
```
   fileprivate static func request(endpoint: String, query: [String : Any] = [:]) -> Observable<[String : Any]> {
    
        do {
            guard let url = URL(string: API)?.appendingPathComponent(endpoint), var components = URLComponents(url: url, resolvingAgainstBaseURL: true) else {
                throw EOError.invalidURL(endpoint)
            }
            
            components.queryItems = try query.flatMap { (key, value) in
                guard let v = value as? CustomStringConvertible else {
                    throw EOError.invalidParameter(key, value)
                }
                return URLQueryItem(name: key , value: v.description)
            }
            
            guard let finalURL = components.url else {
                throw EOError.invalidURL(endpoint)
            }
            
            let request = URLRequest(url: finalURL)
            return URLSession.shared.rx.response(request: request).map { _, data -> [String : Any] in
                guard let jsonObject = try? JSONSerialization.jsonObject(with: data, options: []), let result = jsonObject as? [String : Any] else {
                    throw EOError.invalidJSON(finalURL.absoluteString)
                }
                return result
            }
        } catch {
            return Observable.empty()
        }
    }
```
æˆ‘ä»¬ä»è¯·æ±‚çš„å‡½æ•°å¼€å§‹è®²èµ·, å’Œä¹‹å‰ä¸åŒçš„æ˜¯, è¿™æ¬¡æˆ‘ä»¬å°†è¯·æ±‚ç›´æ¥å°è£…åœ¨æ¨¡å‹é‡Œ, ä¼ ç»Ÿçš„MVCæ¨¡å¼.
- é€šè¿‡å¯¹`API`æ¥å£è¿›è¡Œæ ¡éªŒå¾—åˆ°å¯ç”¨çš„`URLComponents`, å¦‚æœurlä¸å¯ç”¨æŠ›å‡ºå¼‚å¸¸.
- å°†å‚æ•°èµ‹å€¼ç»™`URLQueryItem`, å¦‚æœ`value`ä¸ç¬¦åˆè§„åˆ™æŠ›å‡ºå¼‚å¸¸.
- æ‹¿åˆ°æœ€ç»ˆçš„`URL`, å¦‚æœæ‹¿ä¸åˆ°æŠ›å‡ºå¼‚å¸¸.
- å°†`URL`è½¬æ¢æˆ`URLRequest`.
- è¿›è¡ŒJSONåºåˆ—åŒ–, è¿”å›`(HTTPURLResponse, Data)`ä¸­çš„`Data`.
- å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™è¿”å›ç©ºçš„å¯è§‚å¯Ÿåºåˆ—.

```
    static var categories: Observable<[EOCategory]> = {
        return EONET.request(endpoint: categoriesEndpoint)
            .map { data in
                let categories = data["categories"] as? [[String: Any]] ?? []
                return categories
                    .flatMap(EOCategory.init)
                    .sorted { $0.name < $1.name }
            }
            .shareReplay(1)
    }()

    ...

    fileprivate static func events(forLast days: Int, closed: Bool, endpoint: String) -> Observable<[EOEvent]> {
        
        return request(endpoint: eventsEndpoint, query: [
            "days": NSNumber(value: days),
            "status": (closed ? "closed" : "open")
        ]).map { json in
            guard let raw = json["events"] as? [[String : Any]] else {
                throw EOError.invalidJSON(endpoint)
            }
            return raw.flatMap(EOEvent.init)
        }
    }
```
æ¥ç€æˆ‘ä»¬å¯¹categoriesçš„å¤–éƒ¨å˜é‡è¿›è¡Œè®¡ç®—å±æ€§çš„getæ–¹æ³•.
- è¿›è¡Œè¯·æ±‚è°ƒç”¨ä¸Šé¢çš„è¯·æ±‚å¹¶ä¼ å…¥å°¾éƒ¨èŠ‚ç‚¹.
- è¿›è¡Œæ’åºå¹¶`map`æ˜ å°„åˆ°`EOCategory `æ¨¡å‹ä¸Š.
- `shareReplay(1)`å°†è¯·æ±‚è¿›è¡Œä¸€æ¬¡ç¼“å­˜, ä¸‹æ¬¡è°ƒç”¨è®¢é˜…ä¸å†è¿›è¡Œè¯·æ±‚.
- `events`å’Œ`categories`ç›¸åŒ, è¿›è¡Œè¯·æ±‚æ˜ å°„.

```
static func events(forLast days: Int = 360) -> Observable<[EOEvent]> {
  let openEvents = events(forLast: days, closed: false)
  let closedEvents = events(forLast: days, closed: true)
  return openEvents.concat(closedEvents)
}
```
- å°†`closedEvents `è¿›è¡Œè¯·æ±‚æ˜ å°„åçš„æ¨¡å‹æ•°ç»„æ·»åŠ åˆ°`openEvents`ä¹‹å.

```
    static func events(forLast days: Int = 360, category: EOCategory) -> Observable<[EOEvent]> {

        let openEvents = events(forLast: days, closed: false, endpoint: category.endpoint)
        let closedEvents = events(forLast: days, closed: true, endpoint: category.endpoint)
        
        return Observable.of(openEvents, closedEvents).merge().reduce([]) { running, new in
            running + new
        }
    }
```
- è¿›è¡Œ`marge`, ç”¨å·¥`git`çš„åŒå­¦ä¸€å®šçŸ¥é“, å…¶æ•ˆæœå’Œ`concat`ç±»ä¼¼.

```
func startDownload() {
        
        download.progress.progress = 0.0
        download.label.text = "Download: 0%"
        
        let eoCategories = EONET.categories
        let downloadedEvents = eoCategories.flatMap { categories in
            return Observable.from(categories.map { category in
                EONET.events(forLast: 360, category: category)
            })
            }.merge(maxConcurrent: 2)
        let updatedCategories = eoCategories.flatMap { categories in
            downloadedEvents.scan(categories) { updated, events in
                return updated.map { category in
                    let eventsForCategory = EONET.filteredEvents(events: events, forCategory: category)
                    if !eventsForCategory.isEmpty {
                        var cat = category
                        cat.events = cat.events + eventsForCategory
                        return cat
                    }
                    return category
                }
            }
        }
        eoCategories.concat(updatedCategories).bind(to: categories).addDisposableTo(disposeBag)
    }

```
è¿™æ®µæ˜¯æˆ‘ä»¬æœ¬èŠ‚çš„é‡å¤´æˆ, æˆ‘ä»¬é€ä¸€æ¥è®²è§£ä¸‹:
- `eoCategories `é¦–å…ˆæˆ‘ä»¬æ‹¿åˆ°è¯·æ±‚åˆ°çš„æ•°æ®`EONET.categories` å±æ€§è§‚å¯Ÿgetè¿›è¡Œè¯·æ±‚, è¿™ä¸ªä¹‹å‰è¯´è¿‡äº†.
- `downloadedEvents `é€šè¿‡`flatMap `æ˜ å°„è½¬æ¢æˆ`merge`åˆå¹¶åçš„æ¯ä¸ªç›¸å¯¹åº”çš„`EOEvent`æ¨¡å‹æ•°ç»„, å¹¶å‘æ•°è®¾ä¸º2.
- `updatedCategories`é€šè¿‡`flatMap`æ˜ å°„è¿›è¡Œå¯¹åˆå¹¶å®Œçš„`downloadedEvents`æ¨¡å‹æ•°ç»„è¿›è¡Œ`scan`æ‰«æ, å¹¶é‡æ–°ç»„åˆæ–°çš„`category`å†…çš„`events`æ¨¡å‹æ•°ç»„.
- æœ€åå°†æ›´æ–°åçš„æ•°æ®`concat`æ·»åŠ å¹¶`bind`ç»‘å®šåœ¨`categories`å˜é‡ä¸Šå°±å¤§åŠŸå‘Šæˆäº†.

```
    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
        let cell = tableView.dequeueReusableCell(withIdentifier: "categoryCell")!

        let category = categories.value[indexPath.row]
        cell.textLabel?.text = "\(category.name) (\(category.events.count))"
        cell.accessoryType = (category.events.count > 0) ? .disclosureIndicator : .none
        return cell
    }
```
- categorieså³ä¸ºä¸Šé¢è¯·æ±‚æ˜ å°„è¿‡æ»¤ç»„åˆåç»‘å®šçš„å˜é‡, é€šè¿‡å¯¹Cellçš„è‡ªå®šä¹‰ å°±èƒ½å¤Ÿå¾—åˆ°ä¸‹é¢è¯·æ±‚çš„åˆ—è¡¨äº†.
![](http://upload-images.jianshu.io/upload_images/1229762-de67226ed07f5b2e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å®Œæˆäº†ç¬¬ä¸€ä¸ªé¡µé¢, æˆ‘ä»¬å¼€å§‹ç€ä¸‹ä¸€ä¸ªé¡µé¢: EventsViewController
```
        tableView.rowHeight = UITableViewAutomaticDimension
        tableView.estimatedRowHeight = 60
```
- è¿›è¡ŒAutolayoutçº¦æŸå, æˆ‘ä»¬å¯ä»¥åœ¨æ·»åŠ ä»¥ä¸‹ä»£ç æ¥ä»£æ›¿ä¹‹å‰å¤æ‚çš„cellé«˜åº¦çš„è¿ç®—.

```
        events.asObservable().subscribe(onNext: { [weak self] _ in
            self?.tableView.reloadData()
        }).addDisposableTo(disposeBag)
        
        Observable.combineLatest(days.asObservable(), events.asObservable()) { (days, events) -> [EOEvent] in
            let maxInterval = TimeInterval(days * 24 * 3600)
            return events.filter { event in
                if let date = event.closeDate {
                    return abs(date.timeIntervalSinceNow) < maxInterval
                }
                return true
            }
        }.bind(to: filteredEvent).addDisposableTo(disposeBag)
    
        filteredEvent.asObservable().subscribe(onNext: { [weak self] _ in
            self?.tableView.reloadData()
        }).addDisposableTo(disposeBag)

        days.asObservable().subscribe(onNext: { [weak self] days in
            self?.daysLabel.text = "Last \(days) days"
        }).addDisposableTo(disposeBag)
```
- `events`æ˜¯ä»ä¸Šä¸ªé¡µé¢ä¼ é€’è¿‡æ¥çš„å˜é‡, ç±»å‹ä¸º`let events = Variable<[EOEvent]>([])`
- é€šè¿‡å¯¹`events`çš„ä½œä¸ºå¯è§‚å¯Ÿåºåˆ—å¹¶è¿›è¡Œè®¢é˜…, å½“å¯è§‚å¯Ÿè€…è¢«æ·»åŠ è¿›è®¢é˜…å°±è¿›è¡Œåˆ—è¡¨çš„åˆ·æ–°.
- `Observable.combineLatest()`å¯¹æ—¥æœŸå’Œæ—¶é—´åšæœ€åçš„ç»‘å®š, åªä¿ç•™å¯è§‚å¯Ÿåºåˆ—çš„æœ€åçš„å€¼çš„ç»„åˆ,å¹¶è¿›è¡Œè¿‡æ»¤ç»‘å®šåœ¨`filteredEvent`å˜é‡ä¸Š, ç±»å‹æ˜¯`let filteredEvent = Variable<[EOEvent]>([])`
- æ¥ä¸‹æ¥ä¸¤è¡Œå¯¹äºå…³æ³¨æœ¬ç³»åˆ—çš„åŒå­¦åº”è¯¥ä¸ç”¨è§£é‡Š, å°±æ˜¯è¿›è¡Œè®¢é˜…å¹¶åˆ·æ–°UI.

```
    @IBAction func sliderAction(_ sender: AnyObject) {
        days.value = Int(slider.value)
    }
```
æœ€åå¯¹slideræ·»åŠ äº‹ä»¶, å¹¶æ”¹å˜daysçš„å€¼.æ¥ä¸‹æ¥ä¼šè§¦å‘ä¸€ç³»åˆ—çš„è®¢é˜….
```
        days.asObservable().subscribe(onNext: { [weak self] days in
            self?.daysLabel.text = "Last \(days) days"
        }).addDisposableTo(disposeBag)
```
-  è§¦å‘ä¸Šé¢çš„è®¢é˜…å¹¶è¿›è¡Œ`UILabel`çš„UIåˆ·æ–°

```
        Observable.combineLatest(days.asObservable(), events.asObservable()) { (days, events) -> [EOEvent] in
            let maxInterval = TimeInterval(days * 24 * 3600)
            return events.filter { event in
                if let date = event.closeDate {
                    return abs(date.timeIntervalSinceNow) < maxInterval
                }
                return true
            }
        }.bind(to: filteredEvent).addDisposableTo(disposeBag)
```
-  è§¦å‘`combineLatest`æœ€æ–°ç»„åˆè¿ç®—ç¬¦, å¹¶é‡æ–°è¿›è¡Œè¿‡æ»¤ç»‘å®š.

```
        events.asObservable().subscribe(onNext: { [weak self] _ in
            self?.tableView.reloadData()
        }).addDisposableTo(disposeBag)

```
- åœ¨å¯¹`event`è¿‡æ»¤çš„è¿‡ç¨‹ä¸­è§¦å‘è®¢é˜…è¿›è¡Œåˆ—è¡¨åˆ·æ–°.

```
        filteredEvent.asObservable().subscribe(onNext: { [weak self] _ in
            self?.tableView.reloadData()
        }).addDisposableTo(disposeBag)
```
- åœ¨è¿‡æ»¤å®Œæˆé‡æ–°ç»‘å®šå, è§¦å‘è®¢é˜…è¿›è¡Œæœ€åçš„åˆ·æ–°.

æœ¬æ–‡å› ä¸ºç¯‡å¹…æ‰€é™, ä»…ä¿ç•™ä¸€äº›æ ¸å¿ƒçš„ä»£ç , å¹¶å¯¹æ ¸å¿ƒä»£ç è¿›è¡Œé€æ¡è®²è§£, éœ€è¦è¯¦ç»†äº†è§£, è¯·å»githubä¸‹è½½æºç åå¯¹ç…§é˜…è¯». é€šè¿‡å¯¹äºå¯è§‚å¯Ÿåºåˆ—, è¿‡æ»¤, æ˜ å°„, ç»„åˆçš„ç†è§£å’Œå®æˆ˜, é€šè¿‡ä¸€ä¸ªäº‹ä»¶çš„æ”¹å˜å¼‚æ­¥è§¦å‘è®¢é˜…çš„å“åº”å¼ç¼–ç¨‹çš„æ€æƒ³, æˆ‘ä»¬åº”è¯¥å·²ç»èƒ½ç®—å…¥é—¨äº†.

æ¼”ç¤ºæ•ˆæœ:

![](http://upload-images.jianshu.io/upload_images/1229762-c95ba5ed107bd458.gif?imageMogr2/auto-orient/strip)

About: 

![ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·³è½¬!!](http://upload-images.jianshu.io/upload_images/1229762-3f8925783027b3fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 [ğŸŒŸ æºç  è¯·ç‚¹è¿™é‡ŒğŸŒŸ >>> å–œæ¬¢çš„æœ‹å‹è¯·ç‚¹å–œæ¬¢ >>> ä¸‹è½½æºç çš„åŒå­¦è¯·é€ä¸‹å°æ˜Ÿæ˜Ÿ >>> æœ‰é—²é’±çš„å£•ä»¬å¯ä»¥è¿›è¡Œæ‰“èµ >>> å°å¼Ÿä¼šå°½å¿«æ¨å‡ºæ›´å¥½çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº« >>> ä½ çš„æ¿€åŠ±å°±æ˜¯æˆ‘çš„åŠ¨åŠ›!! ](https://github.com/coderZsq/coderZsq.target.swift)
