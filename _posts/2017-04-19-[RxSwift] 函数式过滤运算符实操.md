---
layout: post
title: RxSwift å‡½æ•°å¼è¿‡æ»¤è¿ç®—ç¬¦å®æ“
date: 2017.04.19 11:50
tag: ç§»åŠ¨å¼€å‘
---

> æ¥ç€ä¸Šä¸€éƒ¨åˆ†, æˆ‘ä»¬å·²ç»å®Œæˆäº†å‡½æ•°å¼ç¼–ç¨‹çš„ç®€å•å®è·µ, ä¹ŸåŒæ—¶æ¥è§¦äº†`Photos`æ¡†æ¶å¸¦æ¥çš„è‡ªå®šä¹‰çš„ä¾¿åˆ©, ä¸»è¦ç†Ÿæ‚‰äº†`Variable`, `Subject` ä½œä¸º `Observable` è¿›è¡Œè®¢é˜… `subscribe` å¹¶é€šè¿‡å¤„ç½®åŒ…`DisposeBag` å¤„ç†çš„å…·ä½“æ¡ˆä¾‹, è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥è¿›ä¸€æ­¥å®Œå–„ç›¸ç‰‡æ‹¼å›¾. ä»£ç è§:[github](https://github.com/coderZsq/coderZsq.target.swift)

![](http://upload-images.jianshu.io/upload_images/1229762-a67b7f2ab21d4b23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬èŠ‚æ‰€éœ€çš„ä¸€äº›å…³äºè®¢é˜…ä¿¡æ¯è¿‡æ»¤çš„åŸºæœ¬çŸ¥è¯†å·²ç»æ›´æ–°åˆ°[github](https://github.com/coderZsq/coderZsq.target.swift)ä»£ç ä¸­çš„playgroundæ–‡ä»¶ä¸­, æ²¡æœ‰æ¥è§¦è¿‡å“åº”å¼ç¼–ç¨‹çš„åŒå­¦è¯·å’Œä¹‹å‰ä¸€æ ·å…ˆè¡Œåœ¨[playground](https://github.com/coderZsq/coderZsq.target.swift/blob/master/AlbumPuzzle/AlbumPuzzle.playground/Contents.swift)ä¸­äº†è§£æ¦‚è¦ä»¥ä¾¿æ›´å¥½çš„ç†è§£æœ¬æ–‡. åœ¨è¿›è¡Œå¯¹é¡¹ç›®çš„å®Œå–„ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜:
```
example(of: "Sharing subscription") {
    
    var start = 0
    func getStartNumber() -> Int {
        start += 1
        return start
    }
    
    let numbers = Observable<Int>.create { observer in
        
        let start = getStartNumber()
        observer.onNext(start)
        observer.onNext(start+1)
        observer.onNext(start+2)
        observer.onCompleted()
        return Disposables.create()
    }
    
    numbers.subscribe(
        onNext: { el in
            print("element [\(el)]")
        },
        onCompleted: {
            print("---------------")
        }
    )
    
    numbers.subscribe(
        onNext: { el in
            print("element [\(el)]")
        },
        onCompleted: {
            print("---------------")
        }
    )
}

---Example of: Sharing subscription ---
element [1]
element [2]
element [3]
---------------
element [2]
element [3]
element [4]
---------------

```
åŒæ ·æ˜¯å¯¹äºå¯è§‚å¯Ÿå¯¹è±¡è¿›è¡Œè®¢é˜…ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸¤ç§ä¸åŒçš„ç»“æœ? é—®é¢˜æ˜¯ï¼Œæ¯æ¬¡è°ƒç”¨subscribeï¼ˆ...ï¼‰æ—¶ï¼Œéƒ½ä¼šä¸ºè¯¥è®¢é˜…åˆ›å»ºä¸€ä¸ªæ–°çš„Observableï¼Œå¹¶ä¸”æ¯ä¸ªå‰¯æœ¬ä¸èƒ½ä¿è¯ä¸ä¹‹å‰çš„ç›¸åŒã€‚ å³ä½¿Observableç¡®å®äº§ç”Ÿäº†ç›¸åŒçš„å…ƒç´ åºåˆ—ï¼Œä¸ºæ¯ä¸ªè®¢é˜…ç”Ÿæˆç›¸åŒçš„é‡å¤å…ƒç´ ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ 

```
example(of: "Sharing subscription Fix") {
        
    var start = 0
    func getStartNumber() -> Int {
        start += 1
        return start
    }
    
    let numbers = Observable<Int>.create { observer in
        
        let start = getStartNumber()
        observer.onNext(start)
        observer.onNext(start+1)
        observer.onNext(start+2)
        observer.onCompleted()
        return Disposables.create()
    }
    
    let shareNumbers = numbers.share()
    
    shareNumbers.subscribe(
        onNext: { el in
            print("element [\(el)]")
        },
        onCompleted: {
            print("---------------")
        }
    )
    
    shareNumbers.subscribe(
        onNext: { el in
            print("element [\(el)]")
        },
        onCompleted: {
            print("---------------")
        }
    )
}

---Example of: Sharing subscription Fix ---
element [1]
element [2]
element [3]
---------------
---------------
```
å¦‚æœéœ€è¦è¿›è¡Œå…±äº«è®¢é˜…ï¼Œå¯ä»¥ä½¿ç”¨shareï¼ˆï¼‰è¿ç®—ç¬¦ã€‚ Rxä»£ç ä¸­çš„å¸¸è§æ¨¡å¼æ˜¯é€šè¿‡è¿‡æ»¤æ¯ä¸ªç»“æœä¸­çš„ä¸åŒå…ƒç´ æ¥ä»åŒä¸€ä¸ªæºä¸­åˆ›å»ºå‡ ä¸ªåºåˆ—ã€‚

å›åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ¥çœ‹å¦‚ä½•å°†share()è¿ç®—ç¬¦è¿ç”¨çš„å®é™…, å°†ViewControllerä¸­çš„ä»£ç ä¿®æ”¹å¦‚ä¸‹:
```
class ViewController: UIViewController {
    ...
    fileprivate var imageCache = [Int]() //update
    ...
}
```
```
    //update
    fileprivate func updateNavigationIcon() {
        let icon = imagePreview.image?.scaled(CGSize(width: 22, height: 22)).withRenderingMode(.alwaysOriginal)
        navigationItem.leftBarButtonItem = UIBarButtonItem(image: icon, style: .done, target: nil, action: nil)
    }
```
```
    @IBAction func actionAdd() {
//        images.value.append(UIImage(named: "Castie!")!)
        
        let albumViewController = storyboard?.instantiateViewController(withIdentifier: "AlbumViewController") as! AlbumViewController
        
        //update
        let newImages = albumViewController.selectedImages.share()

        newImages.takeWhile { [weak self] image in
                return (self?.images.value.count ?? 0) < 6
            }.filter { newImage in
                return newImage.size.width > newImage.size.height
            }.filter { [weak self] newImage in
                let len = UIImagePNGRepresentation(newImage)?.count ?? 0
                guard self?.imageCache.contains(len) == false else { return false }
                self?.imageCache.append(len)
                return true
            }.subscribe(
                
            onNext: { [weak self] newImage in
                guard let images = self?.images else { return }
                images.value.append(newImage)
            },
            onDisposed: {
                print("completed photo selection")
            }
                
        ).addDisposableTo(albumViewController.bag)
        
        newImages.ignoreElements().subscribe(
            onCompleted: { [weak self] in
            self?.updateNavigationIcon()
        }).addDisposableTo(albumViewController.bag)
        
        navigationController?.pushViewController(albumViewController, animated: true)
    }
    
    @IBAction func actionClear() {
        images.value = []
        //update
        imageCache = []
    }

```
æˆ‘ä»¬æ¥å…·ä½“åˆ†æ`actionAdd()` è¿™æ®µä»£ç , é¦–å…ˆ, æˆ‘ä»¬é€šè¿‡`share()`æ“ä½œç¬¦å¯¹å¯è§‚å¯Ÿå¯¹è±¡è¿›è¡Œè®¢é˜…å…±äº«`takeWhile()`æ“ä½œç¬¦å°†å¾—åˆ°çš„è®¢é˜…ä¿¡æ¯è¿›è¡Œè¿‡æ»¤, è¿”å›æœ€å¤§å…­å¼ å›¾ç‰‡å’Œä¹‹å‰å¯¹ç‚¹å‡»æŒ‰é’®çš„å±è”½é€»è¾‘è¿›è¡Œäº†å¯¹åº”, `filter()`æ“ä½œç¬¦å°±æ˜¯ä¼ ç»Ÿçš„å‡½æ•°å¼è¿‡æ»¤, è¿”å›å›¾ç‰‡å®½åº¦å¤§äºé«˜åº¦çš„å›¾ç‰‡åŠé€šè¿‡å›¾ç‰‡å­—èŠ‚æ•°å’Œç¼“å­˜æ± ä¸­çš„å­—èŠ‚æ•°åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å¼ å›¾ç‰‡. è¿™é‡Œæˆ‘ä»¬æ–°åŠ äº†ä¸€ä¸ªè®¢é˜… `ignoreElements()` æ“ä½œç¬¦æ˜¯å¿½ç•¥æ‰€æœ‰çš„`onNext()`äº‹ä»¶, åªæ¥æ”¶`onCompleted ()`äº‹ä»¶. UIå±‚é¢æˆ‘ä»¬åœ¨å·¦ä¸Šè§’æ·»åŠ äº†ä¸€ä¸ªå¯¹åº”å›¾ç‰‡çš„ç¼©ç•¥å›¾.

```
    //update
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        selectedImagesSubject.onCompleted()
    }
```
æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å¯¹AlbumViewControllerç”Ÿå‘½å‘¨æœŸç»“æŸçš„æ—¶å€™å¯¹å¯è§‚å¯Ÿå¯¹è±¡è¿›è¡Œ`onCompleted()`è°ƒç”¨, æ‰§è¡Œä¹‹å‰çš„è®¢é˜…ä»£ç ä¿®æ”¹UI.
![](http://upload-images.jianshu.io/upload_images/1229762-718f23f9c824c8bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¿è¡ŒæˆåŠŸå, æˆ‘ä»¬é¡ºåˆ©çš„çœ‹åˆ°å·¦ä¸Šè§’çš„ç¼©ç•¥å›¾æ˜¾ç¤ºäº†, å¹¶ä¸”ä¸èƒ½é‡å¤æ·»åŠ å¤§äºå…­å¼ å›¾ç‰‡åŠåªå…è®¸å®½åº¦å¤§äºé•¿åº¦çš„å›¾ç‰‡. ä½†æˆ‘ä»¬è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜, å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è®¿é—®ç›¸å†Œçš„æ—¶å€™, ä¼šå¼¹å‡ºä¸€ä¸ªæç¤ºæ¡†å¯¹ç”¨æˆ·è¡Œä¸ºè¿›è¡Œæˆæƒ, ä½†æˆæƒå®Œæˆå, å›¾ç‰‡å¹¶æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥, è¿™æ˜¯å› ä¸ºæ‡’åŠ è½½çš„æ—¶å€™åœ¨æˆæƒéªŒè¯å‰å¹¶æ²¡æœ‰æ‹¿åˆ°ä»»ä½•çš„æ•°æ®. æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è§£å†³. æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ–‡ä»¶, å¹¶å¯¹PHPhotoLibraryè¿›è¡Œç±»æ‰©å±•.

PHPhotoLibraryå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç”¨æˆ·å›¾åº“ï¼ŒåŒ…å«äº†ä¸€äº›çš„å›¾ç‰‡å’Œç›¸å†Œï¼ŒåŒæ—¶åŒ…å«æœ¬åœ°çš„å’ŒiCloudä¸­çš„èµ„æºã€‚å½“Photos appå‘ç”Ÿå›¾ç‰‡çš„ä¿®æ”¹ã€å¢åŠ ã€åˆ é™¤ç­‰æ”¹å˜æ—¶ï¼Œä½¿ç”¨PHPhotoLibraryæ¥åšä¸€äº›åˆ·æ–°UIï¼Œä¿å­˜æ•°æ®ç­‰å“åº”åŠ¨ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ³¨å†Œè§‚å¯Ÿè€…ï¼ˆä½¿ç”¨registerChangeObserveræ–¹æ³•ï¼‰ï¼Œå½“Photos appå†…å®¹å‘ç”Ÿæ”¹å˜çš„æ—¶ï¼Œä¼šè§¦å‘ä»£ç†æ–¹æ³•photoLibraryDidChangeã€‚
```
extension PHPhotoLibrary {

    static var authorized: Observable<Bool> {
        return Observable.create { observer in

            DispatchQueue.main.async {
                if authorizationStatus() == .authorized {
                    observer.onNext(true)
                    observer.onCompleted()
                } else {
                    observer.onNext(false)
                    requestAuthorization { newStatus in
                        observer.onNext(newStatus == .authorized)
                        observer.onCompleted()
                    }
                }
            }
            
            return Disposables.create()
        }
    }
}

```
è¿™é‡Œå¯¹äºåˆšå­¦ä¹ Swiftçš„åŒå­¦å¯èƒ½å¹¶ä¸æ˜¯å¾ˆå¥½ç†è§£, è¿™é‡Œæˆ‘ä»¬å¯¹`PHPhotoLibrary`æ‰©å±•äº†ä¸€ä¸ª`authorized`å±æ€§, å¹¶é€šè¿‡è®¡ç®—å±æ€§è¿”å›äº†ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡, å¯¹è§‚å¯Ÿå¯¹è±¡è¿›è¡Œæˆæƒæ ¡éªŒ, å¦‚æœæ ¡éªŒè¿‡å°±æ‰§è¡Œæ“ä½œ, æ²¡æœ‰æ ¡éªŒè¿‡å°±è¯·æ±‚æˆæƒæ ¡éªŒ, è¿™é‡Œå¼€äº†ä¸€ä¸ªGCDçš„ä¸»çº¿ç¨‹, ä½†ä¸€èˆ¬æ¥è¯´åœ¨è®¢é˜…ä¸­æ˜¯è§‚å¯Ÿå™¨ä¸åº”è¯¥é˜»æ­¢å½“å‰çº¿ç¨‹. æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨AlbumViewControllerä¸­è¿›è¡Œä½¿ç”¨.

```
    override func viewDidLoad() {
        super.viewDidLoad()
        self.collectionView!.register(UICollectionViewCell.self, forCellWithReuseIdentifier: reuseIdentifier)
        //update
        let authorized = PHPhotoLibrary.authorized.share()
        
        authorized.skipWhile { $0 == false }.take(1).subscribe(onNext: { [weak self] _ in
            self?.images = AlbumViewController.loadImages()
            DispatchQueue.main.async {
                self?.collectionView?.reloadData()
            }
        }).addDisposableTo(bag)
        
        authorized.skip(1).takeLast(1).filter { $0 == false }.subscribe(onNext: { [weak self] _ in
            guard let errorMessage = self?.errorMessage else { return }
                DispatchQueue.main.async(execute: errorMessage)
        }).addDisposableTo(bag)
    }
```
æˆ‘ä»¬é€šè¿‡è®¢é˜…å…±äº«çš„å½¢å¼è¿›è¡Œ, ç¬¬ä¸€ä¸ªè®¢é˜…æˆæƒéªŒè¯å½“éªŒè¯æˆåŠŸåè¿›è¡Œè·å–ç³»ç»Ÿç›¸å†Œå›¾ç‰‡, å¹¶åœ¨ä¸»çº¿ç¨‹åˆ·æ–°UI, ç¬¬äºŒä¸ªæ˜¯å‘èµ·è¯·æ±‚éªŒè¯åä»æ²¡æœ‰éªŒè¯å, ä¸»çº¿ç¨‹æ‰§è¡Œé”™è¯¯æç¤ºå¼¹çª—. ä»£ç ä¸­çš„`skipWhile()`, `take()`,`skip()`, `takeLast()`æ“ä½œç¬¦, ä¸ç†è§£çš„åŒå­¦å¯ä»¥åˆ°é¡¹ç›®ä¸­çš„playgroundä¸­å…ˆè¡Œäº†è§£.
```
    fileprivate func errorMessage() {
        alert(title: "No access to Camera Roll",
              text: "You can grant access to Combinestagram from the Settings app")
            .take(5.0, scheduler: MainScheduler.instance)
            .subscribe(onDisposed: { [weak self] in
                self?.dismiss(animated: true, completion: nil)
                _ = self?.navigationController?.popViewController(animated: true)
        }).addDisposableTo(bag)
    }
```
`errorMessage()` ä¸­éœ€è¦è®²ä¸€ä¸‹çš„æ˜¯`.take(5.0, scheduler: MainScheduler.instance)` ä»ç»™å®šæ—¶é—´æ®µçš„æºåºåˆ—ä¸­è·å–å…ƒç´ ã€‚ ä¸€æ—¦æ—¶é—´é—´éš”è¿‡å»ï¼Œå®Œæˆç»“æœåºåˆ—ã€‚æˆ‘ä»¬åœ¨ViewControllerä¸­ä¹Ÿæ›´æ”¹å¦‚ä¸‹:

```
    fileprivate func setupObservable() {
        //update
        images.asObservable().throttle(0.5, scheduler: MainScheduler.instance).subscribe(onNext: { [weak self] images in
            guard let preview = self?.imagePreview else { return }
            preview.image = UIImage.collage(images: images, size: preview.frame.size)
            }).addDisposableTo(bag)
        
        images.asObservable().subscribe(onNext: { [weak self] images in
            self?.updateUI(images: images)
        }).addDisposableTo(bag)
    }
```
`.throttle(0.5, scheduler: MainScheduler.instance)`å’Œåˆšæ‰çš„`take(_:scheduler:)`éå¸¸ç›¸ä¼¼, æ˜¯åœ¨ä¸€å®šæ—¶é—´é—´éš”å†…è¿‡æ»¤æ‰ä¹‹å‰çš„å…ƒç´ åªç•™ä¸‹æœ€æ–°çš„å…ƒç´ ,

æ¼”ç¤ºæ•ˆæœ:
![](http://upload-images.jianshu.io/upload_images/1229762-c9e974553e6ba09b.gif?imageMogr2/auto-orient/strip)

About: 

![ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·³è½¬!!](http://upload-images.jianshu.io/upload_images/1229762-3f8925783027b3fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 [ğŸŒŸ æºç  è¯·ç‚¹è¿™é‡ŒğŸŒŸ >>> å–œæ¬¢çš„æœ‹å‹è¯·ç‚¹å–œæ¬¢ >>> ä¸‹è½½æºç çš„åŒå­¦è¯·é€ä¸‹å°æ˜Ÿæ˜Ÿ >>> æœ‰é—²é’±çš„å£•ä»¬å¯ä»¥è¿›è¡Œæ‰“èµ >>> å°å¼Ÿä¼šå°½å¿«æ¨å‡ºæ›´å¥½çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº« >>> ä½ çš„æ¿€åŠ±å°±æ˜¯æˆ‘çš„åŠ¨åŠ›!! ](https://github.com/coderZsq/coderZsq.target.swift)
