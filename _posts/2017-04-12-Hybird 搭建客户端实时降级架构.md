---
layout: post
title: Hybird æ­å»ºå®¢æˆ·ç«¯å®æ—¶é™çº§æ¶æ„
date: 2017.04.12 16:37
tag: ç§»åŠ¨å¼€å‘
---

> RouterçœŸæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸€ç§è®¾è®¡æ¨¡å¼, èƒ½å¤Ÿåšåˆ°è¶…ä½çš„è€¦åˆ, ä½œä¸ºç³»åˆ—çš„æœ€åä¸€èŠ‚, æˆ‘ä»¬æ¥ç»Ÿç­¹ä¸‰ç«¯, å®ç°çƒ­ä¿®å¤æ¶æ„, å†æ¥è¯´ä¸‹è¿™ä¸ªæ¶æ„çš„å®šä¹‰, å°±æ˜¯å½“Nativeé¡µé¢ä¸šåŠ¡é€»è¾‘å‡ºç°Bugæ—¶, åˆä¸èƒ½é©¬ä¸Šæ‰“åŒ…ä¸Šçº¿é€šè¿‡å®¡æ ¸çš„æƒ…å†µä¸‹, é€šè¿‡åå°é…ç½®å°†é¡µé¢é™çº§ä¸ºH5çš„é¡µé¢, ç­‰å¾…ä¿®å¤å®Œæˆä¸Šçº¿åå†å›åˆ°Nativeçš„è®¾è®¡æ€æƒ³.

![](http://upload-images.jianshu.io/upload_images/1229762-3866097366648136.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

###### å‚è€ƒé“¾æ¥:

- [Hybird æ­å»ºé›¶è€¦åˆæ¶æ„ä»MVCå¼€å§‹](http://www.jianshu.com/p/5a03995a6ce1)
- [Hybird æ­å»ºåç«¯Koa.jså¹¶è¿‡åº¦åˆ°MVVM](http://www.jianshu.com/p/846b9f181cb7)
- [Hybird æ­å»ºå‰ç«¯Vue.jså¹¶å‡çº§è‡³MVP](http://www.jianshu.com/p/8d4a84e3ddaa)
- [Hybird æ­å»ºè·¯ç”±Routerå®ç°ç»„ä»¶åŒ–](http://www.jianshu.com/p/36314d0c0032)

ä»¥ä¸‹å†…å®¹åœ¨ä¸Šè¿°æ–‡ç« åŸºç¡€ä¸Šè¿›è¡Œ, è¯·äº‹å…ˆæŸ¥é˜….

ä¸è¿‡å†™åˆ°è¿™é‡Œ, ä¸ç¦æ„Ÿè§‰è‡ªå·±å†™çš„è¿™ä¸ªæ¶æ„ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„çƒ­æ›´æ–°, è€Œæ˜¯å˜ç›¸çš„æ›¿ä»£, å°±åƒAT&Tçš„èœ‚çªæ•°æ®ä»LTEé™åˆ°3Gä¸€æ ·, å°±æ˜¯åŠ è½½çš„é€Ÿåº¦ä¸Šçš„å·®å¼‚, ä½†æƒ³å¿…ä¹Ÿæ¯”æœ‰Bugæ¥çš„å¥½å§.

æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥å®Œæˆå‰ç«¯çš„é¡µé¢å§, ä½œä¸ºMç«™, å¯¼èˆªæ åœ¨æµè§ˆå™¨çš„è®¿é—®ä¸‹éœ€è¦æ˜¾ç¤ºè€Œåœ¨ç§»åŠ¨ç«¯çš„é™çº§æ—¶ä¸éœ€è¦, æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥å®Œæˆè¿™é¡¹å·¥ä½œ, é¦–å…ˆæˆ‘ä»¬éœ€è¦é€šè¿‡getå‚æ•°æ¥åˆ¤æ–­è·³è½¬æƒ…å†µ.

```
src
â”œâ”€â”€ javascripts
â”‚Â Â  â”œâ”€â”€ http.js
â”‚Â Â  â””â”€â”€ regex.js
```

regex.js

```
export function URLQuery(key) {

  let reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
  let r = window.location.search.substr(1).match(reg);
  if (r != null) {
    return unescape(r[2]);
  }
  return null;
}

```
æ¥ç€æˆ‘ä»¬åˆ›å»ºå¯¼èˆªç»„ä»¶:

```
src
â”œâ”€â”€ components
â”‚Â Â  â”œâ”€â”€ J1.vue
â”‚Â Â  â””â”€â”€ navigation.vue
```

navigation.vue

```
<template lang="html">
  <div v-show="show">
    <div class="nav">
        <span class="title">{{documentTitle}}</span>
    </div>
    <div class="nav-offset"></div>
  </div>
</template>

<script>

import {
  URLQuery
} from '../javascripts/regex'

export default {
  data () {
    return {
      show: true
    }
  },
  props: {
    documentTitle: String
  },
  mounted:function () {
    if (URLQuery('client') === 'app') {
      this.show = false;
    }
  }
}
</script>

<style scoped>

.nav {
    width: 100%;
    height: 44px;
    position: relative;
    background: rgba(248,248,248,1.0);
    border-bottom: 1px solid lightgray;
    position: fixed;
    top: 0px;
    left: 0px;
    z-index: 1;
}

.nav-offset {
    height: 44px;
}

.title {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

</style>


```

åœ¨J1.vueä¸­æŒ‚è½½å­ç»„ä»¶

```

<template lang="html">
  <div>
    <navigation :documentTitle="title"></navigation> //update
    <div class="cell" v-for="model in models">
        ![](model.imageUrl)
        <span>{{model.text}}</span>
        <span>{{model.detailText}}</span>
    </div>
  </div>
</template>

<script>

import navigation from './navigation' //update
import { GET,URL } from '../javascripts/http'
import { URLQuery } from '../javascripts/regex' //update

export default {
  data () {
    return {
      title: '',
      models: []
    }
  },
  components: { //update
    navigation
  },
  methods: {
    request: function() {
      GET(URL.getJ1List).then((data) => {
          this.models = data.models;
      }).catch((error) => {

      })
    }
  },
  mounted:function () {
    this.title = document.title = "J1";
    this.request();
    // alert(window.location.href);
  }
}
</script>

<style scoped>

.cell {
    height: 100px;
    position: relative;
    border-bottom: 1px solid lightgray;
}

.cell img {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding-left: 10px;
}

.cell span:first-of-type {
    position: absolute;
    top: 35%;
    transform: translateY(-35%);
    padding-left: 84px;
    font-size: 15px;
}

.cell span:last-of-type {
    position: absolute;
    top: 65%;
    transform: translateY(-65%);
    padding-left: 84px;
    font-size: 12px;
}

</style>


```

åœ¨ç§»åŠ¨ç«¯å¯¹webViewé¡µé¢è¿›è¡Œä¼ å‚:

```
extension Router {
    
    func addParam(key: String, value: Any) {
        params?[key] = value
    }
    
    func clearParams() {
        params?.removeAll()
    }
    
    func push(_ path: String) {
        
        guardRouters {
            guard let state = self.routers?[path] as? String else { return }
            
            if state == "app" {
                guard let nativeController = NSClassFromString("RouterPatterm.\(self.map[path]!)") as? UIViewController.Type else { return }
                currentController?.navigationController?.pushViewController(nativeController.init(), animated: true)
            }
            
            if state == "web" { //update
                
                let host = "http://localhost:3000/"
                var query = ""
                let ref = "client=app"
                
                guard let params = self.params else { return }
                for (key, value) in params {
                    query += "\(key)=\(value)&"
                }
                
                self.clearParams()
                
                let webViewController = WebViewController("\(host)\(path)?\(query)\(ref)")
                currentController?.navigationController?.pushViewController(webViewController, animated: true)
            }
        }
    }
}
```

é€šè¿‡clientæ˜¯ä¸æ˜¯appæ¥åˆ¤æ–­å¯¼èˆªæ çš„æ˜¾ç¤ºå’Œéšè—, æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡WKWebViewæ¥è¿›è¡Œå¯¹JSçš„é€šè®¯:

```

class WebViewController: ViewController {
    
    fileprivate lazy var configuretion: WKWebViewConfiguration = { [weak self] in
        let configuretion = WKWebViewConfiguration()
        configuretion.userContentController.add(self!, name: "push") //update
        configuretion.userContentController.add(self!, name: "params") //update
        return configuretion
    }()
    
	...    
}

extension WebViewController: WKScriptMessageHandler {
    
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) { //update
        
        let methods = "\(message.name):"
        let selector = NSSelectorFromString(methods)
        if self.responds(to: selector) {
            self.perform(selector, with: message.body)
        }
    }
}

extension WebViewController {
    
    @objc fileprivate func push(_ path: String) { //update
        Router.shareRouter.push(path)
    }
    
    @objc fileprivate func params(_ params: [String : Any]) { //update
        Router.shareRouter.params = params
    }
}


```

åœ¨JSä¸­æ·»åŠ è·³è½¬å’Œæ·»åŠ å‚æ•°çš„æ–¹æ³•å¹¶é€šè¿‡runtimeçš„æ–¹æ³•åŒ¹é…SELåŸç”Ÿæ–¹æ³•, æ¥ä¸‹æ¥, æˆ‘ä»¬åœ¨å‰ç«¯ä¸­ä¹ŸåŠ å…¥äº¤äº’çš„ä»£ç :

```
â”œâ”€â”€ javascripts
â”‚Â Â  â”œâ”€â”€ http.js
â”‚Â Â  â”œâ”€â”€ native.js
â”‚Â Â  â””â”€â”€ regex.js
```

native.js

```

export function NativePush(path) {
  window.webkit.messageHandlers.push.postMessage(path);
}

export function NativeParams(params) {
  window.webkit.messageHandlers.params.postMessage(params);
}

```
å¹¶åœ¨J1.vueä¸­æ·»åŠ ä¸Šäº¤äº’é€»è¾‘

```
<template lang="html">
  <div>
    <navigation :documentTitle="title"></navigation>
    <div class="cell" v-for="model in models" @click="push('J1')"> //update
        ![](model.imageUrl)
        <span>{{model.text}}</span>
        <span>{{model.detailText}}</span>
    </div>
  </div>
</template>

<script>

import navigation from './navigation'
import { GET,URL } from '../javascripts/http'
import { URLQuery } from '../javascripts/regex'
import { NativePush, NativeParams } from '../javascripts/native' //update

export default {
  data () {
    return {
      title: '',
      models: []
    }
  },
  components: {
    navigation
  },
  methods: {
    request: function() {
      GET(URL.getJ1List).then((data) => {
          this.models = data.models;
      }).catch((error) => {

      })
    },
    push : function(path) { //update
      if (URLQuery('client') === 'app') {
          let params = {
            text : "webç«¯ ä¼ å…¥æ•°æ®",
            code : 1002
          }
          NativeParams(params);
          NativePush(path);
      } else {
          this.$router.push({
                path: '/' + path
          });
      }
    }
  },
  mounted:function () {
    this.title = document.title = "J1";
    this.request();
    // alert(window.location.href);
  }
}
</script>

```

è¿™æ ·æˆ‘ä»¬çš„æ¶æ„è®¾è®¡å°±ç®—åŸºæœ¬å®Œæˆäº†.

å½©è›‹:
ä¸ºæˆ‘ä»¬çš„åç«¯è¿ä¸Šæ•°æ®åº“å§, é€šè¿‡æ¥å£æ”¹å˜æ•°æ®åº“çš„å€¼ä¸ç”¨é‡å¯æœåŠ¡å°±èƒ½å¤Ÿæ“æ§é¡µé¢.
æ•°æ®åº“æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨[mongodb](https://www.mongodb.com/), å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¤§ä¼—æƒ…äººmysql, éšä¾¿... 

å®‰è£…å®Œæˆåæˆ‘ä»¬æ‰§è¡Œ 

1. $ mongod â€“config /usr/local/etc/mongod.conf å¼€å¯æœåŠ¡.
2. $ use J1 //åˆ›å»ºæ•°æ®åº“
3. $ switched to db J1 //åˆ‡æ¢åˆ°æ•°æ®åº“
4. $ db.createCollection('routers') //åˆ›å»ºroutersé›†åˆ
5. $ db.routers.insert({'J1' : 'app'}) //æ’å…¥æ•°æ®åˆ°é›†åˆ

è¿™æ ·æˆ‘ä»¬æ•°æ®åº“çš„å‡†å¤‡å·¥ä½œå°±å®Œæˆäº†, å¯¹äºNodeæˆ‘ä»¬åœ¨package.jsonä¸­å¯¼å…¥mongoose, ç„¶ååœ¨åç«¯çš„ç›®å½•ç»“æ„ä¸Šæ·»åŠ dbè·¯å¾„:

```
db
â”œâ”€â”€ J1
â”‚Â Â  â””â”€â”€ routers.js
â”œâ”€â”€ base.js
â””â”€â”€ config.js
```

config.js

```
const mongoose = require('mongoose');

var db = mongoose.connect('mongodb://localhost/J1');

db.connection.on("error", function(error) {
    console.log("database connect failï¼š" + error);
});

db.connection.on("open", function() {
    console.log("database connect success");
})

db.connection.on('disconnected', function() {
    console.log('database disconnected');
})

exports.mongoose = mongoose;


```

base.js

```
let mongodb = require('./config');
let mongoose = mongodb.mongoose;
let Schema = mongoose.Schema;
let ObjectId = Schema.Types.ObjectId;

exports.mongodb = mongodb;
exports.mongoose = mongoose;
exports.Schema = Schema;
exports.ObjectId = ObjectId;
exports.Mixed = Schema.Types.Mixed;

```

routers.js

```
let base = require('../base');
let ObjectId = base.ObjectId;
let Scheme = new base.Schema({
    J1: String
});

module.exports = base.mongoose.model('routers', Scheme);
```

ç„¶ååœ¨æ¥å£ä¸­è°ƒç”¨æ•°æ®åº“:

J1.js

```
exports.getRouters = async(ctx, next) => {

    var routers = await Routers.find({});
    ctx.body = {
        routers: routers[0]
    }
}

exports.updateRouters = async(ctx, next) => {

    const controller = ctx.params.controller;
    const client = ctx.params.client;

    if (controller === 'J1') {
        Routers.update({
            J1: client
        }, (err, doc) => {
            console.log(doc);
        })
    } else {
        console.log('controller is not exist');
    }
}

```
æ·»åŠ è·¯ç”±:

J1_router.js

```

var router = require('koa-router')();
var J1 = require('../../app/controllers/J1');

router.get('/getRouters', J1.getRouters);
router.get('/updateRouters/:controller/:client', J1.updateRouters); //update
router.get('/getJ1List', J1.getJ1List);

module.exports = router;

```

è¿™æ ·æˆ‘ä»¬åœ¨æœåŠ¡å…¨éƒ¨å¼€å¯çš„æƒ…å†µä¸‹è°ƒç”¨updateRoutersæ¥å£, 

æµè§ˆå™¨è¾“å…¥:
http://localhost:3001/api/J1/updateRouters/J1/web
http://localhost:3001/api/J1/updateRouters/J1/app

æˆ‘ä»¬å°±èƒ½å¤Ÿç›´æ¥æ›´æ”¹æ•°æ®åº“åŠ¨æ€çš„é™çº§æˆ–å‡çº§é¡µé¢äº†.

æœ€åæ¥æ€»ç»“ä¸€ä¸‹, æˆ‘ä»¬é€šè¿‡äº†Swift3 + Vue2 + Koa2, å®ç°äº†å¯é™çº§çš„ç§»åŠ¨ç«¯æ¶æ„:
1. cd /RouterPattern/server/RouterPattern $ npm start å¼€å¯æ¥å£æœåŠ¡å™¨
2. cd /RouterPattern/server/RouterPattern/public/javascripts $ node image.js å¼€å¯å›¾ç‰‡æœåŠ¡å™¨
3. cd /RouterPattern/web/RouterPattern $ npm run dev æ‰“å¼€å‰ç«¯é¡µé¢
4. cd /RouterPattern/app/RouterPattern $ open RouterPatterm.xcworkspace æ‰“å¼€Xcode

ä»¥ä¸Šå°±æ˜¯æˆ‘æƒ³ä¸å¤§å®¶åˆ†äº«çš„è®¾è®¡æ€æƒ³, å¸Œæœ›å¤§å®¶æå‡ºå®è´µæ„è§.

æ¼”ç¤ºæ•ˆæœ:

![RouterPattern.gif](http://upload-images.jianshu.io/upload_images/1229762-32c9c5e7c147b54a.gif?imageMogr2/auto-orient/strip)

About: 

![ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·³è½¬!!](http://upload-images.jianshu.io/upload_images/1229762-3f8925783027b3fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 [ğŸŒŸ æºç  è¯·ç‚¹è¿™é‡ŒğŸŒŸ >>> å–œæ¬¢çš„æœ‹å‹è¯·ç‚¹å–œæ¬¢ >>> ä¸‹è½½æºç çš„åŒå­¦è¯·é€ä¸‹å°æ˜Ÿæ˜Ÿ >>> æœ‰é—²é’±çš„å£•ä»¬å¯ä»¥è¿›è¡Œæ‰“èµ >>> å°å¼Ÿä¼šå°½å¿«æ¨å‡ºæ›´å¥½çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº« >>> ä½ çš„æ¿€åŠ±å°±æ˜¯æˆ‘çš„åŠ¨åŠ›!! ](https://github.com/coderZsq/coderZsq.target.swift)
