---
layout: post
title: RxSwift å¤§ç¥ä»¬éƒ½åœ¨çœ‹çš„å“åº”å¼
date: 2017.04.18 12:13
tag: ç§»åŠ¨å¼€å‘
---


> ä¸Šä¸ªç³»åˆ—çš„æ¶æ„è®¾è®¡, ä»MVC -> MVVM -> MVP -> Router -> Downgradable, æˆ‘ä»¬å®ç°äº†é€šè¿‡åˆ†å±‚å°†å„ä¸ªç»„ä»¶è¿›è¡Œè§£è€¦å¹¶åŠ¨æ€çš„å‡é™çº§é¡µé¢, è¿™ä¸€ç³»åˆ—å‡†å¤‡è¯´è¯´å¦‚ä½•é€šè¿‡RxSwiftè¿›è¡Œå“åº”å¼ç¼–ç¨‹æ›´å¥½çš„å’Œæ¶æ„è®¾è®¡è¿›è¡ŒååŒ. ä»£ç è§:[github](https://github.com/coderZsq/coderZsq.target.swift)

![](http://upload-images.jianshu.io/upload_images/1229762-a67b7f2ab21d4b23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¿™ç³»åˆ—æ‰€è¿°æ¡ˆä¾‹æ˜¯é€šè¿‡Rayå®¶çš„RxSwiftä¸€ä¹¦è¿›è¡Œç¬”è®°, åœ¨å­¦ä¹ æœ¬ç¯‡ä¹‹å‰, è¯·ç¡®ä¿ç†Ÿç»ƒæŒæ¡Swift3åŸºç¡€è¯­æ³•å¹¶å…·å¤‡ä¸­çº§iOSå¼€å‘èƒ½åŠ›. å¯¹äºRxSwiftçš„æ¦‚å¿µä¸æ˜¯å¾ˆæ¸…æ™°çš„åŒå­¦å¯ä»¥å‚ç…§æœ¬æ–‡ä»£ç ä¸­çš„[playground](https://github.com/coderZsq/coderZsq.target.swift/blob/master/AlbumPuzzle/AlbumPuzzle.playground/Contents.swift)äº‹å…ˆç†Ÿæ‚‰, ä¸ç†è§£çš„è¯·å…ˆæŸ¥é˜…æ¦‚è¦, ä»¥ä¾¿æ›´å¥½çš„äº†è§£æœ¬æ–‡.

é¦–å…ˆæˆ‘ä»¬éœ€è¦é€šè¿‡cocapodsè¿›è¡Œå¼•å…¥RxSwift:
```
# Uncomment the next line to define a global platform for your project
platform :ios, '10.0'

target 'AlbumPuzzle' do
    # Comment the next line if you're not using Swift and don't want to use dynamic frameworks
    use_frameworks!
    
    # Pods for AlbumPuzzle
    pod 'RxSwift',    '~> 3.2'
    pod 'RxCocoa',    '~> 3.2'
    
end
```

![](http://upload-images.jianshu.io/upload_images/1229762-46cac43c61b71c6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›å¿…è¦çš„æ§ä»¶, é¿å…ä»£ç è¿‡å¤š, æˆ‘ä»¬å°±é€šè¿‡StoryBoardæ¥è¿›è¡ŒViewå±‚çš„å¸ƒå±€, ç¬¬ä¸€ä¸ªé¡µé¢ä¸­æˆ‘ä»¬éœ€è¦å››ä¸ªæ§ä»¶: å±•ç¤ºå›¾ç‰‡, æ·»åŠ æŒ‰é’®, æ¸…é™¤æŒ‰é’®, ä¿å­˜æŒ‰é’®. ç¬¬äºŒä¸ªé¡µé¢å°±æ˜¯ä¸ªç®€å•çš„CollectoinViewController.

```
class ViewController: UIViewController {
    
    @IBOutlet weak var imagePreview: UIImageView!
    @IBOutlet weak var buttonClear: UIButton!
    @IBOutlet weak var buttonSave: UIButton!
    @IBOutlet weak var itemAdd: UIBarButtonItem!
    
    fileprivate let bag = DisposeBag()
    fileprivate let images = Variable<[UIImage]>([])
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupObservable()
    }
}

extension ViewController {
    
    fileprivate func setupObservable() {
        
        images.asObservable().subscribe(onNext: { [weak self] images in
            guard let preview = self?.imagePreview else { return }
            preview.image = UIImage.collage(images: images, size: preview.frame.size)
        }).addDisposableTo(bag)
        
        images.asObservable().subscribe(onNext: { [weak self] images in
            self?.updateUI(images: images)
        }).addDisposableTo(bag)
    }
    
    fileprivate func updateUI(images: [UIImage]) {
        buttonSave.isEnabled = images.count > 0 && images.count % 2 == 0
        buttonClear.isEnabled = images.count > 0
        itemAdd.isEnabled = images.count < 6
        title = images.count > 0 ? "\(images.count) photos" : "Collage"
    }
}


extension ViewController {
    
    @IBAction func actionAdd() {
        images.value.append(UIImage(named: "Castie!")!)
    }
    
    @IBAction func actionClear() {
        images.value = []
    }
    
    @IBAction func actionSave() {
        
    }
}
```
æˆ‘ä»¬è¿›å…¥ViewController, åˆ›å»ºä¸¤ä¸ªç§æœ‰å˜é‡, bag, æ˜¯ä¸€ä¸ªDisposeBagå®ä¾‹, imagesæ˜¯ä¸€ä¸ªVariableçš„æ³›å‹ `å¯¹äºDisposeBagå’ŒVariableä¸äº†è§£çš„åŒå­¦è¯·äº‹å…ˆæŸ¥é˜…playgroundä¸­çš„å†…å®¹` , é€šè¿‡extensionçš„è¯­æ³•` Swiftçš„è£…é¥°æ¨¡å¼ `è¿›è¡Œä»£ç åˆ†åŒº,  é€šè¿‡å¯¹imagesæ·»åŠ è®¢é˜…ç›‘å¬imagesæ•°ç»„å‘ç”Ÿçš„å˜åŒ–, å¹¶å¯¹æŒ‰é’®ç‚¹å‡»è¿›è¡Œæ“ä½œ. ä¸ºäº†å®ç°æ›´å¥½çš„æ•ˆæœ, éœ€è¦å¼•å…¥UIImage+Collageåˆ†ç±».

![](http://upload-images.jianshu.io/upload_images/1229762-6a3d4c76e8003a66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¿™æ ·æˆ‘ä»¬å°±ç®€å•çš„å®ç°äº†å“åº”å¼ç¼–ç¨‹, å½“è®¢é˜…è€…çš„å€¼è¢«æ”¹å˜çš„æ—¶å€™, å°±ä¼šæ›´æ–°æ“ä½œ. å°±å’ŒKVOçš„ç›‘å¬æ•ˆæœç›¸ä¼¼. ç”±äºiOS10å¼€å§‹å¯¹äºè®¿é—®ç”¨æˆ·ä¿¡æ¯çš„æœºåˆ¶æœ‰æ‰€æ›´æ–°, æœ¬ä¾‹ä¸­éœ€è¦è®¿é—®ç”¨æˆ·ç›¸å†Œ, æ‰€ä»¥åœ¨info.plistè¿›è¡Œå¦‚ä¸‹é…ç½®:
Privacy - Photo Library Usage Description, We need access to your device's photo library to allow you to select photos for your collage.

è¿›è¡Œé…ç½®å®Œæˆ, æˆ‘ä»¬å°±é€šè¿‡Photosç³»ç»Ÿæ¡†æ¶æ¥è¿›è¡Œå¯¹ç³»ç»Ÿç›¸å†Œä¸­çš„å›¾ç‰‡è¿›è¡Œè·å–, å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨UIImagePickerController, é¢„çŸ¥å¦‚ä½•ä½¿ç”¨è¯·[ç‚¹å‡»](http://www.jianshu.com/p/555786f35357)!

```
import UIKit
import Photos
import RxSwift

private let reuseIdentifier = "Cell"

class AlbumViewController: UICollectionViewController {
    
    let bag = DisposeBag()
    var selectedImages: Observable<UIImage> {
        return selectedImagesSubject.asObservable()
    }
    
    fileprivate let selectedImagesSubject = PublishSubject<UIImage>()
    fileprivate lazy var images = AlbumViewController.loadImages()
    fileprivate lazy var imageManager = PHCachingImageManager()
    fileprivate lazy var thumbnailSize: CGSize = {
        let cellSize = (self.collectionViewLayout as! UICollectionViewFlowLayout).itemSize
        return CGSize(width: cellSize.width * UIScreen.main.scale,
                      height: cellSize.height * UIScreen.main.scale)
    }()
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.collectionView!.register(UICollectionViewCell.self, forCellWithReuseIdentifier: reuseIdentifier)
    }
}

extension AlbumViewController {
    
    static func loadImages() -> PHFetchResult<PHAsset> {
        let allImagesOptions = PHFetchOptions()
        allImagesOptions.sortDescriptors = [NSSortDescriptor(key: "creationDate", ascending: true)]
        return PHAsset.fetchAssets(with: allImagesOptions)
    }
}

extension AlbumViewController {
    
    override func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return images.count
    }
    
    override func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        
        let asset = images.object(at: indexPath.item)
        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: reuseIdentifier, for: indexPath)
        imageManager.requestImage(for: asset, targetSize: thumbnailSize, contentMode: .aspectFill, options: nil, resultHandler: { image, _ in
            cell.layer.contents = image?.cgImage
        })
        return cell
    }
    
    override func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        
        let asset = images.object(at: indexPath.item)

        if let cell = collectionView.cellForItem(at: indexPath) {
            cell.alpha = 0
            UIView.animate(withDuration: 0.5, animations: {
                cell.alpha = 1
            })
        }

        imageManager.requestImage(for: asset, targetSize: view.frame.size, contentMode: .aspectFill, options: nil, resultHandler: { [weak self] image, info in
            guard let image = image, let info = info else { return }
            
            if let isThumbnail = info[PHImageResultIsDegradedKey as NSString] as? Bool, !isThumbnail {
                self?.selectedImagesSubject.onNext(image)
            }
        })
    }
}

```
è¿™é‡Œç®€è¦çš„è¯´ä¸‹Photosè¿™ä¸ªç³»ç»Ÿæ¡†æ¶, Photos frameworkæ˜¯iOS8è‹¹æœæä¾›çš„æ–°çš„å›¾ç‰‡æ¡†æ¶ï¼Œèƒ½ç›´æ¥è·å–å›¾ç‰‡å’Œè§†é¢‘ï¼ŒåŒ…æ‹¬iCloudä¸Šé¢çš„å›¾åº“ã€‚ä½¿ç”¨è¿™ä¸ªæ¡†æ¶å¯ä»¥è·å–assetsæ¥å±•ç¤ºå’Œå›æ”¾ï¼Œç¼–è¾‘å›¾ç‰‡æˆ–è€…è§†é¢‘å†…å®¹ï¼Œæˆ–è€…ä½¿ç”¨ç³»ç»Ÿç›¸å†Œã€æ—¶åˆ»ã€å’Œåˆ†äº«åˆ°iCloudçš„ç›¸å†Œæ¥è¿›è¡Œç›¸å…³æ“ä½œ.

æˆ‘ä»¬è¿™é‡Œç”¨åˆ°çš„æœ‰`PHCachingImageManager`, `PHFetchResult`, `PHFetchOptions`, `PHAsset`

PHCachingImageManageræ˜¯PHImageManagerçš„å­ç±»ï¼Œå¦‚æœç›¸å†Œä¸­æœ‰å¤§é‡çš„å›¾ç‰‡ï¼Œè€Œä½ çš„éœ€æ±‚æ˜¯è¦å¿«é€Ÿçš„è·å–è¿™äº›å›¾ç‰‡çš„ç¼©ç•¥å›¾å’Œå¤§å›¾æ•°æ®ç”¨äºå±•ç¤ºï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨PHCachingImageManageræ¥å®ç°ï¼Œå®ƒå…·æœ‰ç¼“å­˜æœºåˆ¶å¯ä»¥å¿«é€Ÿè·å–ä¸€ä¸ªå›¾å†Œçš„ç¼©ç•¥å›¾ï¼Œæˆ–è€…åœ¨åå°è¯·æ±‚å…¨å°ºå¯¸å›¾ç‰‡ä»¥ä¾¿äºå¿«é€Ÿå±•ç¤ºã€‚

```
/**
 *  ä¼šå¤šæ¬¡è°ƒç”¨'resultHandler'ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè¿”å›çš„å›¾ç‰‡æ¸…æ™°åº¦è¾ƒä½ï¼Œ
 *  å½“é«˜æ¸…æ™°åº¦å›¾ç‰‡å¯ä»¥è·å–æ—¶,ä¼šå†æ¬¡è°ƒç”¨ï¼Œå¦‚æœé«˜è´¨é‡çš„å›¾ç‰‡åœ¨ç¼“å­˜æ±‡ä¸­ï¼Œåªè°ƒç”¨ä¸€æ¬¡'resultHandler'ã€‚
 *  è¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯å¼‚æ­¥çš„ï¼Œå½“ä»åå°çº¿ç¨‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œéœ€è¦å°†optionsçš„'synchronous'è®¾ä¸ºYES.
 *
 *  @param asset         ä¿å­˜å›¾ç‰‡ä¿¡æ¯çš„asset
 *  @param targetSize    è¿”å›çš„å›¾ç‰‡å°ºå¯¸
 *  @param contentMode   è¿”å›çš„å›¾ç‰‡æ˜¾ç¤ºæ¨¡å¼
 *  @param options       image request option
 *  @param resultHandler è¿”å›çš„å†…å®¹
 *
 *  @return è¯·æ±‚æ ‡ç¤ºï¼Œç”¨äºå–æ¶ˆè¯·æ±‚*/
    open func requestImage(for asset: PHAsset, targetSize: CGSize, contentMode: PHImageContentMode, options: PHImageRequestOptions?, resultHandler: @escaping (UIImage?, [AnyHashable : Any]?) -> Swift.Void) -> PHImageRequestID
```

PHFetchResultæ˜¯æœ‰åºçš„photoå®ä½“å¯¹è±¡çš„å®¹å™¨ï¼ŒåŒ…å«é€šè¿‡ç»™å®šçš„æ£€ç´¢æ¡ä»¶è¿”å›çš„assetï¼Œç›¸å†Œï¼Œä¸€ä¸ªç›¸å†Œç±»å‹ä¸­çš„æ‰€æœ‰ç›¸å†Œåˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼Œsmart albumç±»å‹ä¸‹çš„æ‰€æœ‰ç›¸å†Œï¼Œå®ƒæ˜¯æœ‰åºçš„ï¼‰ï¼Œåœ¨PHAsset,PHCollection,PHAssetcollection,PHCollectionListè¿™å‡ ä¸ªç±»ä¸­éƒ½åŒ…å«æœ‰ç›¸åº”çš„ç±»æ–¹æ³•åŒ…å«å¯¹åº”ä¿¡æ¯çš„PHFetchRequestå¯¹è±¡,ä¾‹å¦‚ï¼š
```
    open class func fetchAssets(with options: PHFetchOptions?) -> PHFetchResult<PHAsset>
```

PHFetchOptions: å½“ä½ ä½¿ç”¨æ²¡æ–¹æ³•è·å–PHAssetï¼ˆå›¾ç‰‡å’Œè§†é¢‘ï¼‰,PHCollectionï¼ˆç›¸å†Œç±»å‹ï¼‰,PHAssetCollectionï¼ˆç›¸å†Œï¼‰çš„å®ä½“ï¼ˆç›¸å½“äºåŒ…å«å¤šä¸ªæ•°æ®çš„æ¨¡å‹ï¼‰ä½¿ç”¨PHFetchOptionså¯¹è±¡æŒ‡å®šæ“ä½œï¼Œä¾‹å¦‚è·å–çš„å®ä½“çš„æ’åˆ—å±æ€§ç­‰ã€‚

è¿™é‡Œçš„æ“ä½œå¾ˆç®€å•, å°±æ˜¯é€šè¿‡è®¿é—®ç‰¹å®šé€‰é¡¹çš„PHFetchOptionså¾—åˆ°PHFetchResultä¸­çš„PHAssetå¹¶ä½¿ç”¨PHCachingImageManagerè¯·æ±‚ç³»ç»Ÿç›¸å†Œå¾—åˆ°ç›¸åº”çš„å›¾ç‰‡å¹¶é€šè¿‡å¯„å®¿å›¾çš„æ–¹å¼å±•ç¤ºåˆ°Cellä¸Š.


![](http://upload-images.jianshu.io/upload_images/1229762-425a3b6c535f638d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å“åº”å¼ç¼–ç¨‹çš„å…³é”®æˆ‘ä»¬åœ¨Cellç‚¹å‡»çš„å‡½æ•°ä¸­çš„ä»¥ä¸‹ä»£ç :
```
 if let isThumbnail = info[PHImageResultIsDegradedKey as NSString] as? Bool, !isThumbnail {
       self?.selectedImagesSubject.onNext(image)
}
```
é€šè¿‡å‘å¸ƒå¯¹è±¡PublishSubjectçš„onNextæ–¹æ³•å°†æ•°æ®å‘é€ç»™è®¢é˜…è€…, å›åˆ°ViewController, æˆ‘ä»¬å¯¹éƒ¨åˆ†ä»£ç è¿›è¡Œæ›´æ–°:

```
    @IBAction func actionAdd() {
//        images.value.append(UIImage(named: "Castie!")!)
        
        let albumViewController = storyboard?.instantiateViewController(withIdentifier: "AlbumViewController") as! AlbumViewController
        
        albumViewController.selectedImages.subscribe(
            onNext: { [weak self] newImage in
                guard let images = self?.images else { return }
                images.value.append(newImage)
            },
            onDisposed: {
                print("completed photo selection")
            }
        ).addDisposableTo(albumViewController.bag)
        
        navigationController?.pushViewController(albumViewController, animated: true)
    }
```

è¿™æ ·æˆ‘ä»¬å°±é€šè¿‡RxSwiftå®ç°äº†é¡µé¢ä¹‹é—´çš„å“åº”å¼äº¤äº’, æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°å›¾ç‰‡çš„ä¿å­˜æ“ä½œ:
```
class AlbumWriter: NSObject {
    
    typealias Callback = (NSError?)->Void
    
    private var callback: Callback
    private init(callback: @escaping Callback) {
        self.callback = callback
    }
    
    func image(_ image: UIImage, didFinishSavingWithError error: NSError?, contextInfo: UnsafeRawPointer) {
        callback(error)
    }
    
    static func save(_ image: UIImage) -> Observable<Void> {
        return Observable.create({ observer in
            let writer = AlbumWriter(callback: { error in
                if let error = error {
                    observer.onError(error)
                } else {
                    observer.onCompleted()
                }
            })
            UIImageWriteToSavedPhotosAlbum(image, writer, #selector(AlbumWriter.image(_:didFinishSavingWithError:contextInfo:)), nil)
            return Disposables.create()
        })
    }
}
```
å°è£…ä¸€ä¸ªå›¾ç‰‡å‚¨å­˜çš„AlbumWriterç±», é€šè¿‡Createæ–¹æ³•æ¥åˆ›å»ºè§‚å¯Ÿè€….

```
@IBAction func actionSave() {
        
        guard let image = imagePreview.image else { return }
        
        AlbumWriter.save(image).subscribe(
            
            onError: { [weak self] error in
            self?.showMessage("Error", description: error.localizedDescription)
            
            }, onCompleted: { [weak self] in
                self?.showMessage("Saved")
                self?.actionClear()
            }
            
        ).addDisposableTo(bag)
    }

```
æœ€ååœ¨Saveæ“ä½œçš„æ—¶å€™è¿›è¡Œè®¢é˜…å°±å¤§åŠŸå‘Šæˆäº†!!

æ¼”ç¤ºæ•ˆæœ:

![](http://upload-images.jianshu.io/upload_images/1229762-9b240f1eb5dac87a.gif?imageMogr2/auto-orient/strip)



About: 

![ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·³è½¬!!](http://upload-images.jianshu.io/upload_images/1229762-3f8925783027b3fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 [ğŸŒŸ æºç  è¯·ç‚¹è¿™é‡ŒğŸŒŸ >>> å–œæ¬¢çš„æœ‹å‹è¯·ç‚¹å–œæ¬¢ >>> ä¸‹è½½æºç çš„åŒå­¦è¯·é€ä¸‹å°æ˜Ÿæ˜Ÿ >>> æœ‰é—²é’±çš„å£•ä»¬å¯ä»¥è¿›è¡Œæ‰“èµ >>> å°å¼Ÿä¼šå°½å¿«æ¨å‡ºæ›´å¥½çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº« >>> ä½ çš„æ¿€åŠ±å°±æ˜¯æˆ‘çš„åŠ¨åŠ›!! ](https://github.com/coderZsq/coderZsq.target.swift)
