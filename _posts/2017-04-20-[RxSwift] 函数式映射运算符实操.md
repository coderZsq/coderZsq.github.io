---
layout: post
title: RxSwift å‡½æ•°å¼æ˜ å°„è¿ç®—ç¬¦å®æ“
date: 2017.04.20 10:45
tag: ç§»åŠ¨å¼€å‘
---

> ä¸€è·¯èµ°æ¥, æ„Ÿè§‰RxSwiftä¹Ÿä¸åƒä¹‹å‰ä¸€æ ·æ™¦æ¶©éš¾æ‡‚äº†, ç”šè‡³æ¸æ¸çš„å–œæ¬¢ä¸Šäº†è¿™ç§å“åº”å¼ç¼–ç¨‹çš„æ€æƒ³, å°†å¯¹è±¡ä½œä¸ºå¯è§‚å¯Ÿå¯¹è±¡å¹¶è¿›è¡Œè®¢é˜…, åŠ ä¸Šè¿‡æ»¤æ“ä½œç¬¦çš„åä½œ, ä¸€åˆ‡çš„é€»è¾‘è¿ç®—éƒ½åœ¨åå°çº¿ç¨‹æ‰§è¡Œ, æœ¬èŠ‚æ‰€è¦è®²çš„æ˜¯Rxä¸­æœ€ä¸ºå¼ºå¤§çš„åŠŸèƒ½ --- æ˜ å°„, ä»£ç è§:[github](https://github.com/coderZsq/coderZsq.target.swift)

![](http://upload-images.jianshu.io/upload_images/1229762-a67b7f2ab21d4b23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬èŠ‚æ‰€éœ€çš„ä¸€äº›å…³äºæ˜ å°„çš„åŸºæœ¬çŸ¥è¯†å·²ç»æ›´æ–°åˆ°[github](https://github.com/coderZsq/coderZsq.target.swift)ä»£ç ä¸­çš„playgroundæ–‡ä»¶ä¸­, æ²¡æœ‰æ¥è§¦è¿‡å“åº”å¼ç¼–ç¨‹çš„åŒå­¦è¯·å’Œä¹‹å‰ä¸€æ ·å…ˆè¡Œåœ¨[playground](https://github.com/coderZsq/coderZsq.target.swift/blob/master/GitHubRepo/GitHubRepository/GitHubRepository.playground/Contents.swift)ä¸­äº†è§£æ¦‚è¦ä»¥ä¾¿æ›´å¥½çš„ç†è§£æœ¬æ–‡. æœ¬èŠ‚æˆ‘ä»¬å°±é€šè¿‡æ¡ˆä¾‹é€æ­¥ç²¾è®²æ˜ å°„æ“ä½œç¬¦åœ¨ç½‘ç»œè¯·æ±‚æ—¶çš„å¦™ç”¨.

![](http://upload-images.jianshu.io/upload_images/1229762-81e919722e1627dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¿™æ¬¡çš„UIç•Œé¢éå¸¸çš„ç®€å•,  å°±æ˜¯ä¸€ä¸ªç®€å•çš„TableViewController, æˆ‘ä»¬é€šè¿‡ç½‘ç»œè¯·æ±‚å°†è·å–çš„JSONæ•°æ®æ˜ å°„åˆ°Modelä¸Šå¹¶å±•ç¤ºåœ¨Cellä¸Š, API: https://api.github.com/repos/coderZsq/coderZsq.target.swift/events

æƒ³äº†è§£å¦‚ä½•è¿›è¡Œåå°æ­å»ºå¹¶æ¨¡æ‹Ÿæ•°æ®è¿”å›çš„åŒå­¦ è¯·ç‚¹å‡» --> [Hybird å®ç°çƒ­ä¿®å¤æ¶æ„ ä»MVCè¯´èµ·](http://www.jianshu.com/p/5a03995a6ce1)

```
{
    "id": "5715074941",
    "type": "PushEvent",
    "actor": {
      "id": 19483268,
      "login": "coderZsq",
      "display_login": "coderZsq",
      "gravatar_id": "",
      "url": "https://api.github.com/users/coderZsq",
      "avatar_url": "https://avatars.githubusercontent.com/u/19483268?"
    },
    "repo": {
      "id": 87806175,
      "name": "coderZsq/coderZsq.target.swift",
      "url": "https://api.github.com/repos/coderZsq/coderZsq.target.swift"
    },
    "payload": {
      "push_id": 1688506435,
      "size": 1,
      "distinct_size": 1,
      "ref": "refs/heads/master",
      "head": "90306f546ee0e17d94891415a2f8938d28736dc7",
      "before": "778ac2b60b85a3e97e0a1e85e16cdb1061445181",
      "commits": [
        {
          "sha": "90306f546ee0e17d94891415a2f8938d28736dc7",
          "author": {
            "email": "a13701777868@yahoo.com",
            "name": "Castie!"
          },
          "message": "Update README.md",
          "distinct": true,
          "url": "https://api.github.com/repos/coderZsq/coderZsq.target.swift/commits/90306f546ee0e17d94891415a2f8938d28736dc7"
        }
      ]
    },
    "public": true,
    "created_at": "2017-04-19T12:12:49Z"
  }
```
æˆ‘ä»¬å…ˆä»æµè§ˆå™¨çœ‹ä¸‹æ¥å£æ‰€è¿”å›çš„å­—æ®µ, å¹¶æå–æˆ‘ä»¬éœ€è¦çš„å­—æ®µç”Ÿæˆæ¨¡å‹Model, ä»¥å¤‡ä¹‹åçš„æ˜ å°„.
```
typealias AnyDict = [String: Any]

class Event {

    let repo: String
    let name: String
    let imageUrl: URL
    let action: String
    
    init?(dictionary: AnyDict) {
        guard let repoDict = dictionary["repo"] as? AnyDict,
            let actor = dictionary["actor"] as? AnyDict,
            let repoName = repoDict["name"] as? String,
            let actorName = actor["display_login"] as? String,
            let actorUrlString = actor["avatar_url"] as? String,
            let actorUrl  = URL(string: actorUrlString),
            let actionType = dictionary["type"] as? String
            else {  return nil  }
        
        repo = repoName
        name = actorName
        imageUrl = actorUrl
        action = actionType
    }
    
    var dictionary: AnyDict {
        return [
            "repo" : ["name": repo],
            "actor": ["display_login": name, "avatar_url": imageUrl.absoluteString],
            "type" : action
        ]
    }
}

```
æˆ‘ä»¬å°†æ¨¡å‹å‘½åä¸ºEvent, æ·»åŠ äº†ä¸€ä¸ªdictionaryå˜é‡ä¾›è¿”å›åºåˆ—åŒ–å®Œæˆåçš„å­—å…¸.

```
    func fetchEvents(repo: String) {
        
        let response = Observable.from([repo]).map { urlString -> URL in
                return URL(string: "https://api.github.com/repos/\(urlString)/events")!
            }.map { [weak self] url -> URLRequest in
                var request = URLRequest(url: url)
                if let modifiedHeader = self?.lastModified.value {
                    request.addValue(modifiedHeader as String,forHTTPHeaderField: "Last-Modified")
                }
                return request
            }.flatMap { request -> Observable<(HTTPURLResponse, Data)> in
                return URLSession.shared.rx.response(request: request)
            }.shareReplay(1)
        
        response.filter { response, _ in
                return 200..<300 ~= response.statusCode
            }.map { _, data -> [[String: Any]] in
                guard let jsonObject = try? JSONSerialization.jsonObject(with: data, options: []),
                    let result = jsonObject as? [[String: Any]] else { return [] }
                return result
            }.filter { objects in
                return objects.count > 0
            }.map { objects in
                return objects.flatMap(Event.init)
            }.subscribe(onNext: { [weak self] newEvents in
                self?.processEvents(newEvents)
            }).addDisposableTo(bag)
    }
```
ä¸€åˆ‡å‡†å¤‡å°±ç»ª, æˆ‘ä»¬å°±æ¥è¯´è¯´æœ¬èŠ‚æœ€é‡è¦çš„éƒ¨åˆ†äº†, æˆ‘ä»¬é€è¡Œæ¥è¿›è¡Œè®²è§£.
- é€šè¿‡`Observable.from()`çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡, ä¼ å…¥`repo`å­—æ®µ, é€šè¿‡`map`æ˜ å°„æˆ`URL`è¿”å›.
- é€šè¿‡`map`æ˜ å°„å°†`URL`æ˜ å°„æˆ`URLRequest`, å¦‚æœæœ‰è¿›è¡Œä¿®æ”¹åˆ™å†™å…¥è¯·æ±‚å¤´.
- é€šè¿‡'flatmap'æ˜ å°„å°†å°†`URLRequest`æ˜ å°„æˆ`HTTPURLResponse `, ç½‘ç»œè¯·æ±‚å°è£…åœ¨`RxCocoa`çš„`URLSession.shared.rx.response(request:)`æ–¹æ³•ä¸­, æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹æºç , å½“ç„¶è¿™äº›éƒ½æ˜¯åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œçš„.
- æœ€åé€šè¿‡`shareReplay(1)`è¿›è¡Œè®¢é˜…å…±äº«. `shareReplay`å¯ä»¥å°†ä¹‹å‰å“åº”ç»“æœåŠ å…¥ç¼“å†²åŒº. è¿™ä¹Ÿæ˜¯ä¸ä½¿ç”¨`share()`çš„åŸå› , é¿å…å¤šæ¬¡è¯·æ±‚.

å¯¹äºflatmap å’Œ map ä¹‹å‰çš„åŒºåˆ«ä¸äº†è§£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹[playground](https://github.com/coderZsq/coderZsq.target.swift/blob/master/GitHubRepo/GitHubRepository/GitHubRepository.playground/Contents.swift)ä¸­çš„ä¾‹å­, æˆ–è€…ç›´æ¥æŸ¥çœ‹Swiftä¸­çš„Arrayæ–‡æ¡£.

```
    /// Returns an array containing the non-`nil` results of calling the given
    /// transformation with each element of this sequence.
    ///
    /// Use this method to receive an array of nonoptional values when your
    /// transformation produces an optional value.
    ///
    /// In this example, note the difference in the result of using `map` and
    /// `flatMap` with a transformation that returns an optional `Int` value.
    ///
    ///     let possibleNumbers = ["1", "2", "three", "///4///", "5"]
    /// 
    ///     let mapped: [Int?] = numbers.map { str in Int(str) }
    ///     // [1, 2, nil, nil, 5]
    /// 
    ///     let flatMapped: [Int] = numbers.flatMap { str in Int(str) }
    ///     // [1, 2, 5]
    ///
    /// - Parameter transform: A closure that accepts an element of this
    ///   sequence as its argument and returns an optional value.
    /// - Returns: An array of the non-`nil` results of calling `transform`
    ///   with each element of the sequence.
    ///
    /// - Complexity: O(*m* + *n*), where *m* is the length of this sequence
    ///   and *n* is the length of the result.
    public func flatMap<ElementOfResult>(_ transform: (Element) throws -> ElementOfResult?) rethrows -> [ElementOfResult]
```

æ‹¿åˆ°äº†å“åº”ç»“æœ, æˆ‘ä»¬å¯¹ç›¸åº”ç»“æœè¿›è¡Œè¿‡æ»¤, å¦‚æœå¯¹è¿‡æ»¤ä¸äº†è§£çš„åŒå­¦, è¯·ç¿»çœ‹ä¹‹å‰çš„æ–‡ç«  --> [RxSwift å“åº”å¼ç¼–ç¨‹å®æˆ˜ è¿‡æ»¤è¿ç®—ç¬¦](http://www.jianshu.com/p/04349d324a6f)

- é€šè¿‡`filter `è¿‡æ»¤æ‰é”™è¯¯çš„statusCode, å¯¹äºstatusCodeä¸äº†è§£çš„åŒå­¦å¯ä»¥æŸ¥é˜…HTTPçŠ¶æ€ç çš„èµ„æ–™, `~=`æ“ä½œç¬¦æ˜¯æŒ‡æ“ä½œç¬¦å³è¾¹çš„å€¼æ˜¯å¦åœ¨æ“ä½œç¬¦å·¦è¾¹çš„èŒƒå›´ä¹‹å†…, è¿”å›Boolç±»å‹,
- å¾—åˆ°æ­£ç¡®çš„æ•°æ®å, é€šè¿‡`map`è¿›è¡Œæ˜ å°„å°†æ•°æ®æ˜ å°„æˆå­—å…¸æ•°ç»„ç±»å‹, ä½¿ç”¨çš„æ˜¯ç³»ç»Ÿçš„JSONåºåˆ—åŒ–.
- å†æ¬¡è¿›è¡Œ`filter`è¿‡æ»¤, è¿‡æ»¤æ‰æ²¡æœ‰è¿”å›çš„æ•°æ®.
- å†æ¬¡è¿›è¡Œ`map`æ˜ å°„, å°†æ•°æ®ç»“æ„æ˜ å°„åˆ°Eventæ¨¡å‹ä¸­.
- æœ€åè¿›è¡Œè®¢é˜…æ‰§è¡Œæ“ä½œå¹¶æ·»åŠ åˆ°`DisposeBag`ä¸­.

æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸‹æ‹¿åˆ°äº†æ˜ å°„å®Œæˆåçš„[Event]æ¨¡å‹æ•°ç»„åçš„æ‰§è¡Œæ“ä½œ.
```
    func processEvents(_ newEvents: [Event]) {
        
        var updatedEvents = newEvents + events.value
        if updatedEvents.count > 50 {
            updatedEvents = Array<Event>(updatedEvents.prefix(upTo: 50))
        }
        
        events.value = updatedEvents
        tableView.reloadData()
        refreshControl?.endRefreshing()
        
        let eventsArray = updatedEvents.map{ $0.dictionary } as NSArray
        eventsArray.write(to: eventsFileURL, atomically: true)
        
    }
```
- æ‹¿åˆ°æ¨¡å‹æ•°ç»„çš„ä¸ªæ•°åå–å¦‚æœè¶…è¿‡50ä¸ª, å–å‰é¢50ä¸ªæ•°æ®.
- åˆ·æ–°tableView, refreshControlç»“æŸåˆ·æ–°, å¹¶å°†æ˜ å°„æ¨¡å‹ç¼“å­˜åˆ°æ²™ç›’.

```
func cachedFileURL(_ fileName: String) -> URL {
    return FileManager.default.urls(for: .cachesDirectory, in: .allDomainsMask).first!.appendingPathComponent(fileName)
}

class ViewController: UITableViewController {

    fileprivate let repo = "coderZsq/coderZsq.target.swift"
    fileprivate let events = Variable<[Event]>([])
    fileprivate let bag = DisposeBag()
    
    fileprivate let eventsFileURL = cachedFileURL("events.plist")
    fileprivate let modifiedFileURL = cachedFileURL("modified.txt")
    fileprivate let lastModified = Variable<NSString?>(nil)
    
    override func viewDidLoad() {
        super.viewDidLoad()
        title = repo
        
        let eventsArray = (NSArray(contentsOf: eventsFileURL)
            as? [[String: Any]]) ?? []
        events.value = eventsArray.flatMap(Event.init)
        lastModified.value = try? NSString(contentsOf: modifiedFileURL, usedEncoding: nil)
        
        setupRefreshControl()
    }
}
```
- `cachedFileURL`ç¼“å­˜è·¯å¾„åœ°å€
- æ¯æ¬¡å…ˆæ‰§è¡Œç¼“å­˜æœ¬åœ°çš„æ˜ å°„æ•°æ®å†è¿›è¡Œç½‘ç»œè¯·æ±‚.

æ˜ å°„å’Œè¿‡æ»¤çš„å¥½å¤„åœ¨äºä¸€åˆ‡éƒ½åœ¨åå°çº¿ç¨‹è¿›è¡Œ, å¹¶åœ¨æ˜ å°„å’Œè¿‡æ»¤çš„è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿä¸åŒ¹é…çš„æƒ…å†µ, ä¹‹åçš„æ“ä½œå°±ä¼šè¢«æ‰“æ–­, ä¸å†æ‰§è¡Œ.

æ¼”ç¤ºæ•ˆæœ:
![](http://upload-images.jianshu.io/upload_images/1229762-86d2e2011251ccd6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

About: 

![ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·³è½¬!!](http://upload-images.jianshu.io/upload_images/1229762-3f8925783027b3fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 [ğŸŒŸ æºç  è¯·ç‚¹è¿™é‡ŒğŸŒŸ >>> å–œæ¬¢çš„æœ‹å‹è¯·ç‚¹å–œæ¬¢ >>> ä¸‹è½½æºç çš„åŒå­¦è¯·é€ä¸‹å°æ˜Ÿæ˜Ÿ >>> æœ‰é—²é’±çš„å£•ä»¬å¯ä»¥è¿›è¡Œæ‰“èµ >>> å°å¼Ÿä¼šå°½å¿«æ¨å‡ºæ›´å¥½çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº« >>> ä½ çš„æ¿€åŠ±å°±æ˜¯æˆ‘çš„åŠ¨åŠ›!! ](https://github.com/coderZsq/coderZsq.target.swift)
