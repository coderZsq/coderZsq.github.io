<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>Castie! Notes</title>
  <meta name="description"
    content="  GitHub Repo：coderZsq.project.iosFollow: coderZsq · GitHubResume: https://coderzsq.github.io/coderZsq.practice.web/">
  <meta name="author" content="Wei Wang">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title"
    content="iOS 网络性能优化浅析">
  <meta name="twitter:description"
    content="  GitHub Repo：coderZsq.project.iosFollow: coderZsq · GitHubResume: https://coderzsq.github.io/coderZsq.practice.web/">

  <meta property="og:type" content="article">
  <meta property="og:title"
    content="iOS 网络性能优化浅析">
  <meta property="og:description"
    content="  GitHub Repo：coderZsq.project.iosFollow: coderZsq · GitHubResume: https://coderzsq.github.io/coderZsq.practice.web/">

  <link rel="icon" type="image/ico" href="/assets/images/favicon.ico" />
  <link href="/assets/images/favicon.ico" rel="shortcut icon" type="image/ico">

  <link rel="stylesheet" href="/css/main.css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/2018/08/iOS-%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%B5%85%E6%9E%90/">
  <link rel="alternate" type="application/rss+xml" title="Castie!"
    href="http://localhost:4000/feed.xml">

  <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" />
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>

  <body>

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/assets/images/background-cover.jpg')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/#blog" title="前往 Castie! 的主页" class="blog-button"><img src="/assets/images/avatar.jpg" width="80" alt="Castie! logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for Castie!" class="blog-button">Castie!</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">正态分布, 优劣伴生</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">北冥有鱼，其名为鲲（kūn）。鲲之大，不知其几千里也；化而为鸟，其名为鹏。鹏之背，不知其几千里也；怒而飞，其翼若垂天之云。是鸟也，海运则将徙于南冥。南冥者，天池也。</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        
        
        <p class="panel-cover__description">北海若曰：“井鼃不可以语于海者，拘于虚也；夏虫不可以语于冰者，笃于时也；曲士不可以语于道者，束于教也。今尔出于崖涘，观于大海，乃知尔丑，尔将可与语大理矣。</p>
        
        
        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
                
                  <li class="navigation__item"><a href="https://coderzsq.github.io/coderZsq.practice.web/" target="_blank" title="我的简历">简历</a></li>
                
              </ul>
            </nav>
          </div>
          
          <div><nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
    <!-- juejin-->
    <li class="navigation__item">
      <a href="https://juejin.im/user/57e735dfa22b9d00614eecb8/posts" title="@coderZsq 的稀土掘金" target="_blank">
        <i class='social fa fa-book'></i>
        <span class="label">juejin</span>
      </a>
    </li>
    

  

  
  <!-- Github -->
  <li class="navigation__item">
    <a href="https://github.com/coderZsq" title="@coderZsq 的 Github" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>
  

  

  

  <!-- RSS -->
  <li class="navigation__item">
    <a href="/feed.xml" rel="author" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>

  
  <!-- Email -->
  <li class="navigation__item">
    <a href="mailto:a13701777868@gmail.com" title="Contact me">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>
  

  </ul>
</nav>
</div>
        </div>
      </div>
    </div>
    
    
    <div class="panel-cover--overlay cover-disabled"></div>
    
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-08-23 17:30:00 +0800" itemprop="datePublished" class="post-meta__date date">2018-08-23</time> &#8226; <span class="post-meta__tags tags">移动开发</span>
    </div>
    <h1 class="post-title">iOS 网络性能优化浅析</h1>
  </header>

  <section class="post">
    <blockquote>
  <p>GitHub Repo：<a href="https://github.com/coderZsq/coderZsq.project.ios">coderZsq.project.ios</a>
<br />Follow: <a href="https://github.com/coderZsq">coderZsq · GitHub</a>
<br />Resume: <a href="https://coderzsq.github.io/coderZsq.practice.web/">https://coderzsq.github.io/coderZsq.practice.web/</a></p>
</blockquote>

<h4 id="日常扯淡">日常扯淡</h4>

<p>emm~~ 最近有好多<code class="highlighter-rouge">大厂疯狂招人</code>, 也有很多朋友抛出了橄榄枝要来<code class="highlighter-rouge">内推</code>我, 在此我表示万分感谢, 但以小弟的简历… 真的连简历都过不了… 最近在学习<code class="highlighter-rouge">Python</code>, 真的学了<code class="highlighter-rouge">Python</code>才感受到了编程的乐趣啊, <code class="highlighter-rouge">爬虫</code>, <code class="highlighter-rouge">自动化</code>, <code class="highlighter-rouge">数据分析</code>, <code class="highlighter-rouge">机器学习</code>, <code class="highlighter-rouge">区块链</code> 真的是感觉掌控了先进科技了… 我把所有学习<code class="highlighter-rouge">Python</code>的代码放在了这里–&gt; <a href="https://github.com/coderZsq/coderZsq.practice.data">仓库</a>, 会逐步更新的, 希望能够共同学习和进步!</p>

<p>诶… 一直在自学<code class="highlighter-rouge">Python</code>, <code class="highlighter-rouge">iOS</code>都不太会敲了, 想想之前看了<code class="highlighter-rouge">函数式编程</code>的书, 又想学着写写如何设计一个网络框架, 就有了今天这篇文章, 虽然也没啥技术含量….</p>

<p>对于<code class="highlighter-rouge">iOS</code>, <code class="highlighter-rouge">Apple</code>市值破万亿, 说明当初选择这个方向还是不错的, 但是现在的趋势真的是好多在职的<code class="highlighter-rouge">iOS</code>都在往<code class="highlighter-rouge">大数据</code>和<code class="highlighter-rouge">人工智能</code>方向上转, 真的, 我感觉<code class="highlighter-rouge">iOS</code>各个都是全栈, 什么都会真的牛逼, 我也要跟随大佬的步伐, 继续我的学习之旅了~~</p>

<h4 id="网络优化">网络优化</h4>

<p>说实话, <code class="highlighter-rouge">网络优化</code>基本是根据你的项目来的, <code class="highlighter-rouge">不同的需求会有不同的方案</code>, 但思想上是想通的, 大体就是, 缓存, 缓存, 缓存… 总结为如下几点:</p>

<ul>
  <li>减少, 压缩网络数据</li>
  <li>如果多次请求结果是相同的, 经量使用缓存</li>
  <li>使用断点续传, 否则网络不稳定的时候可能多次传输相同的内容</li>
  <li>网络不可用的时候, 不要尝试执行网络请求</li>
  <li>让用户可以取消长时间运行或者速度很慢的网络操作, 设置合适的超时时间</li>
  <li>批量传输，比如，下载视频流时，不要传输很小的数据包，直接下载整个文件或者一大块一大块地下载。如果下载广告，一次性多下载一些，然后再慢慢展示。如果下载电子邮件，一次下载多封，不要一封一封地下载.</li>
</ul>

<h4 id="http">HTTP</h4>

<p>说起网络, 肯定要说到<code class="highlighter-rouge">HTTP</code>了, 这个真的绕不过去, 对于<code class="highlighter-rouge">HTTP</code>可以看看我学习实践的代码–&gt; <a href="https://github.com/coderZsq/coderZsq.practice.web/tree/master/study-notes/http">仓库</a></p>

<p>当然这个是用<code class="highlighter-rouge">JS</code>写的, 而且这个需要服务端的支持, 简单来说就是设置一些头信息, <code class="highlighter-rouge">cache-control</code> 这个字段就非常虫咬了, 是做一些缓存处理的, 设置<code class="highlighter-rouge">max-age</code>就可以设定超时时间. <code class="highlighter-rouge">accept</code>设置为<code class="highlighter-rouge">gzip</code>之类的就可以进行网络数据的压缩..</p>

<p>这种都是常规操作, 就不过多赘述了…</p>

<h4 id="准备工作">准备工作</h4>

<p>这个在上一篇<code class="highlighter-rouge">iOS 界面性能优化浅析</code>的基础上进行, 在我们<code class="highlighter-rouge">server.js</code>中添加代码.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="nb">decodeURI</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"/get"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span>
        <span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="na">data</span><span class="p">:</span> <span class="s2">"GET Method"</span><span class="p">,</span>
            <span class="na">status</span><span class="p">:</span> <span class="s1">'Success'</span>
        <span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">decodeURI</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"/post"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>  
        <span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">body</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span>
        <span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="na">data</span><span class="p">:</span> <span class="s2">"POST Method"</span><span class="p">,</span>
            <span class="na">status</span><span class="p">:</span> <span class="s1">'Success'</span>
        <span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">decodeURI</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"/image"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/contents/Castie!.jpg'</span><span class="p">;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s1">'binary'</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'image/jpeg'</span>
                <span class="p">});</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="s1">'binary'</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>我们就简单的开了三个接口来模拟<code class="highlighter-rouge">get请求</code>, <code class="highlighter-rouge">post请求</code>和<code class="highlighter-rouge">图片请求</code> 这些基本上覆盖了我们<code class="highlighter-rouge">80%</code>的需求了吧.</p>

<h4 id="如何设计">如何设计</h4>

<p>一个网络框架如何设计? 说实话, 我也不知道, 看了<code class="highlighter-rouge">AFNetworking</code>和<code class="highlighter-rouge">SDWebImage</code>的源码, 就会发现<code class="highlighter-rouge">侧重点</code>都是不同的. 做为开发者, 当然不能<code class="highlighter-rouge">生搬硬套</code>别人的思想, 所以我就按自己的理解来进行设计了.</p>

<p>我在写代码的时候, 有<code class="highlighter-rouge">自顶向下</code>设计的习惯, 首先把接口写出来, 关键是要让别人<code class="highlighter-rouge">用的爽</code>, 然后再进行具体的实现.</p>

<p>所以我们先看下之前<code class="highlighter-rouge">AFN</code>我们是怎么用的.</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "Service.h"
#import &lt;AFNetworking.h&gt;
</span>
<span class="k">@implementation</span> <span class="nc">Service</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">fetchMockDataWithParam</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameter</span> <span class="nf">completion</span><span class="p">:(</span><span class="n">RequestCompletionBlock</span><span class="p">)</span><span class="nv">completion</span> <span class="p">{</span>
    
    <span class="n">AFHTTPSessionManager</span> <span class="o">*</span> <span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="nf">manager</span><span class="p">];</span>
    <span class="p">[</span><span class="n">manager</span> <span class="nf">GET</span><span class="p">:</span><span class="s">@"http://localhost:8080/fetchMockData"</span> <span class="nf">parameters</span><span class="p">:</span><span class="n">parameter</span> <span class="n">progress</span><span class="o">:</span><span class="nb">nil</span> <span class="n">success</span><span class="o">:^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">task</span><span class="p">,</span> <span class="n">id</span>  <span class="n">_Nullable</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">responseObject</span><span class="p">[</span><span class="s">@"status"</span><span class="p">]</span> <span class="nf">isEqualToString</span><span class="p">:</span> <span class="s">@"success"</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">completion</span><span class="p">(</span><span class="n">responseObject</span><span class="p">[</span><span class="s">@"data"</span><span class="p">],</span> <span class="nb">nil</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">task</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">completion</span><span class="p">(</span><span class="nb">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p>这个是我之前使用<code class="highlighter-rouge">AFN</code>的时候的常规操作, 再看我想要达到的效果:</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "Service.h"
#import "SQFetcher.h"
#import &lt;UIKit/UIKit.h&gt;
</span>
<span class="k">@implementation</span> <span class="nc">Service</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">fetchMockDataWithParam</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameter</span> <span class="nf">completion</span><span class="p">:(</span><span class="n">RequestCompletionBlock</span><span class="p">)</span><span class="nv">completion</span> <span class="p">{</span>
    
    <span class="p">[</span><span class="n">SQFetchManager</span> <span class="nf">managerWithState</span><span class="p">:</span><span class="n">SQFetchSerialState</span><span class="p">]</span>
    
    <span class="p">.</span><span class="n">GET</span><span class="p">(</span><span class="s">@"http://localhost:8090/fetchMockData"</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">responseObject</span><span class="p">[</span><span class="s">@"status"</span><span class="p">]</span> <span class="nf">isEqualToString</span><span class="p">:</span> <span class="s">@"success"</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">completion</span><span class="p">(</span><span class="n">responseObject</span><span class="p">[</span><span class="s">@"data"</span><span class="p">],</span> <span class="nb">nil</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"EXCUTE: http://localhost:8090/fetchMockData"</span><span class="p">);</span>
    <span class="p">},</span> <span class="nb">nil</span><span class="p">)</span>
    
    <span class="p">.</span><span class="n">GET</span><span class="p">(</span><span class="s">@"http://localhost:8090/get"</span><span class="p">,</span> <span class="p">@{</span><span class="s">@"username"</span><span class="o">:</span> <span class="s">@"Castie!"</span><span class="p">,</span>
                                         <span class="s">@"passwd"</span> <span class="o">:</span> <span class="s">@"01234"</span><span class="p">,</span>
                                         <span class="s">@"param0"</span> <span class="o">:</span> <span class="s">@"0.0"</span><span class="p">,</span>
                                         <span class="s">@"param1"</span> <span class="o">:</span> <span class="s">@"1.1"</span><span class="p">,</span>
                                         <span class="s">@"param2"</span> <span class="o">:</span> <span class="s">@"2.2"</span><span class="p">,</span>
                                         <span class="s">@"param3"</span> <span class="o">:</span> <span class="s">@"3.3"</span><span class="p">,</span>
                                         <span class="s">@"param4"</span> <span class="o">:</span> <span class="s">@"4.4"</span><span class="p">,</span>
                                         <span class="p">},</span> <span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">){</span>
             <span class="n">NSLog</span><span class="p">(</span><span class="s">@"EXCUTE: http://localhost:8090/get %@"</span><span class="p">,</span> <span class="n">responseObject</span><span class="p">);</span>
    <span class="p">},</span> <span class="nb">nil</span><span class="p">)</span>
    
    <span class="p">.</span><span class="n">POST</span><span class="p">(</span><span class="s">@"http://localhost:8090/post"</span><span class="p">,</span> <span class="p">@{</span><span class="s">@"username"</span><span class="o">:</span> <span class="s">@"Castie!"</span><span class="p">,</span>
                                           <span class="s">@"passwd"</span> <span class="o">:</span> <span class="s">@"56789"</span><span class="p">,</span>
                                           <span class="s">@"param5"</span> <span class="o">:</span> <span class="s">@"5.5"</span><span class="p">,</span>
                                           <span class="s">@"param6"</span> <span class="o">:</span> <span class="s">@"6.6"</span><span class="p">,</span>
                                           <span class="s">@"param7"</span> <span class="o">:</span> <span class="s">@"7.7"</span><span class="p">,</span>
                                           <span class="s">@"param8"</span> <span class="o">:</span> <span class="s">@"8.8"</span><span class="p">,</span>
                                           <span class="s">@"param9"</span> <span class="o">:</span> <span class="s">@"9.9"</span><span class="p">,</span>
                                           <span class="p">},</span> <span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">){</span>
              <span class="n">NSLog</span><span class="p">(</span><span class="s">@"EXCUTE: http://localhost:8090/post %@"</span><span class="p">,</span> <span class="n">responseObject</span><span class="p">);</span>
    <span class="p">},</span><span class="nb">nil</span><span class="p">)</span>
    
    <span class="p">.</span><span class="n">GET</span><span class="p">(</span><span class="s">@"http://localhost:8090/image"</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"EXCUTE: http://localhost:8090/image %@"</span><span class="p">,</span> <span class="n">responseObject</span><span class="p">);</span>
    <span class="p">},</span><span class="nb">nil</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p>这里的<code class="highlighter-rouge">#import &lt;UIKit/UIKit.h&gt;</code>是不必要的, 只是想表达请求图片也可以的意思.</p>

<p>可以看到, 这种调用, 我们从视觉的角度就非常清晰舒爽了~</p>

<p>刚才的代码, 细心的同学可以看到有一个状态的判断, 这个值可以操作下面<code class="highlighter-rouge">链式调用</code>是串行还是并行, 是不是很神奇~ 妈妈再也不用担心<code class="highlighter-rouge">回调地狱</code>的问题了~</p>

<h4 id="如何实现">如何实现</h4>

<p>那如何实现这个链式调用及控制呢, 来看看我是怎么实现的.</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">,</span> <span class="n">SQFetchState</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SQFetchSerialState</span><span class="p">,</span>
    <span class="n">SQFetchConcurrentState</span>
<span class="p">};</span>

<span class="k">@interface</span> <span class="nc">SQFetchManager</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">SQFetchManager</span> <span class="o">*</span> <span class="p">(</span><span class="o">^</span><span class="n">GET</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">url</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">id</span><span class="p">),</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">failure</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">));</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">SQFetchManager</span> <span class="o">*</span> <span class="p">(</span><span class="o">^</span><span class="n">POST</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">url</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">id</span><span class="p">),</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">failure</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">));</span>

<span class="k">+</span> <span class="p">(</span><span class="n">SQFetchManager</span> <span class="o">*</span><span class="p">)</span><span class="nf">managerWithState</span><span class="p">:(</span><span class="n">SQFetchState</span><span class="p">)</span><span class="nv">state</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre>
</div>
<p>看看头文件, 就能够发现, 我这个属性是不是和你们用的都不太一样, 这是一个<code class="highlighter-rouge">Block</code>, 不要和我说<code class="highlighter-rouge">Block</code>要用<code class="highlighter-rouge">copy</code>修饰, 想想现在<code class="highlighter-rouge">ARC</code>已经多少时间了…. 当然<code class="highlighter-rouge">copy</code>是通用的…</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "SQFetchManager.h"
#import "SQFetchSerialization.h"
#import "SQFetchReachability.h"
#import "SQFetchCache.h"
</span>
<span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">,</span> <span class="n">SQHTTPMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SQGETMethod</span><span class="p">,</span>
    <span class="n">SQPOSTMethod</span>
<span class="p">};</span>

<span class="k">@interface</span> <span class="nc">SQFetchManager</span><span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">NSOperation</span> <span class="o">*</span> <span class="n">preOperation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">NSOperationQueue</span> <span class="o">*</span> <span class="n">operationQueue</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">assign</span><span class="p">)</span> <span class="n">SQFetchState</span> <span class="n">state</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">SQFetchManager</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSOperationQueue</span> <span class="o">*</span><span class="p">)</span><span class="n">operationQueue</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_operationQueue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_operationQueue</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="nf">new</span><span class="p">];</span>
        <span class="n">_operationQueue</span><span class="p">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_operationQueue</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">SQFetchManager</span> <span class="o">*</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">id</span><span class="p">),</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)))</span><span class="n">GET</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">URLString</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">failure</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)){</span>
        <span class="n">NSBlockOperation</span> <span class="o">*</span> <span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBlockOperation</span> <span class="nf">blockOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
            <span class="n">dispatch_semaphore_t</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">semaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">[[</span><span class="n">self</span> <span class="nf">__dataTaskWithHTTPMethod</span><span class="p">:</span><span class="n">SQGETMethod</span>
                                  <span class="nf">URLString</span><span class="p">:</span><span class="n">URLString</span>
                                 <span class="nf">parameters</span><span class="p">:</span><span class="n">parameters</span>
                                    <span class="nf">success</span><span class="p">:</span><span class="n">success</span>
                                    <span class="nl">failure:</span><span class="n">failure</span>
                                  <span class="nl">semaphore:</span><span class="n">semaphore</span><span class="p">]</span> <span class="n">resume</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
        <span class="p">}];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">preOperation</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">operation</span> <span class="nf">addDependency</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">preOperation</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">operationQueue</span> <span class="nf">addOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">preOperation</span> <span class="o">=</span> <span class="n">operation</span><span class="p">;</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">SQFetchManager</span> <span class="o">*</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">id</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)))</span><span class="n">POST</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">URLString</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">failure</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)){</span>
        <span class="n">NSBlockOperation</span> <span class="o">*</span> <span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBlockOperation</span> <span class="nf">blockOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
            <span class="n">dispatch_semaphore_t</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">semaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">[[</span><span class="n">self</span> <span class="nf">__dataTaskWithHTTPMethod</span><span class="p">:</span><span class="n">SQPOSTMethod</span>
                                <span class="nf">URLString</span><span class="p">:</span><span class="n">URLString</span>
                               <span class="nf">parameters</span><span class="p">:</span><span class="n">parameters</span>
                                  <span class="nf">success</span><span class="p">:</span><span class="n">success</span>
                                  <span class="nl">failure:</span><span class="n">failure</span>
                                <span class="nl">semaphore:</span><span class="n">semaphore</span><span class="p">]</span> <span class="n">resume</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
        <span class="p">}];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">preOperation</span><span class="p">)</span>
            <span class="p">[</span><span class="n">operation</span> <span class="nf">addDependency</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">preOperation</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">operationQueue</span> <span class="nf">addOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">preOperation</span> <span class="o">=</span> <span class="n">operation</span><span class="p">;</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="p">)</span><span class="n">__dataTaskWithHTTPMethod</span><span class="o">:</span><span class="p">(</span><span class="n">SQHTTPMethod</span><span class="p">)</span><span class="n">method</span>
                                       <span class="n">URLString</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">URLString</span>
                                      <span class="n">parameters</span><span class="o">:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">parameters</span>
                                         <span class="n">success</span><span class="o">:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">id</span><span class="p">))</span><span class="n">success</span>
                                         <span class="n">failure</span><span class="o">:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">))</span><span class="n">failure</span>
                                       <span class="n">semaphore</span><span class="o">:</span><span class="p">(</span><span class="n">dispatch_semaphore_t</span><span class="p">)</span><span class="n">semaphore</span> <span class="p">{</span>
    <span class="n">SQFetchReachability</span> <span class="o">*</span> <span class="n">reachability</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchReachability</span> <span class="nf">sharedInstance</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reachability</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">NotReachable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">id</span> <span class="n">cache</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchCache</span> <span class="nf">getCacheFromKey</span><span class="p">:</span><span class="n">URLString</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">success</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="n">SQGETMethod</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">URLString</span> <span class="o">=</span> <span class="p">[</span><span class="n">URLString</span> <span class="nf">stringByAppendingString</span><span class="p">:</span>
                     <span class="p">[</span><span class="n">SQFetchSerialization</span> <span class="nf">getMethodSerializationWithParameters</span><span class="p">:</span><span class="n">parameters</span><span class="p">]];</span>
    <span class="p">}</span>

    <span class="n">NSURL</span> <span class="o">*</span> <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">URLString</span><span class="p">];</span>
    <span class="n">NSURLSession</span> <span class="o">*</span> <span class="n">session</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLSession</span> <span class="nf">sessionWithConfiguration</span><span class="p">:[</span><span class="n">NSURLSessionConfiguration</span> <span class="nf">defaultSessionConfiguration</span><span class="p">]];</span>
    <span class="n">NSMutableURLRequest</span> <span class="o">*</span> <span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableURLRequest</span> <span class="nf">requestWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="n">SQPOSTMethod</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">request</span><span class="p">.</span><span class="n">HTTPMethod</span> <span class="o">=</span> <span class="s">@"POST"</span><span class="p">;</span>
        <span class="n">request</span><span class="p">.</span><span class="n">HTTPBody</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchSerialization</span> <span class="nf">postMethodSerializationWithParameters</span><span class="p">:</span><span class="n">parameters</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="n">NSURLSessionDataTask</span> <span class="o">*</span> <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">session</span> <span class="nf">dataTaskWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nf">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">data</span><span class="p">,</span> <span class="n">NSURLResponse</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">response</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span> <span class="n">err</span><span class="p">;</span>
        <span class="n">id</span> <span class="n">responseObject</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchSerialization</span> <span class="nf">serializationWithContentType</span><span class="p">:</span><span class="n">response</span><span class="p">.</span><span class="n">MIMEType</span>
                                                                          <span class="nf">data</span><span class="p">:</span><span class="n">data</span> <span class="n">error</span><span class="o">:</span><span class="n">err</span><span class="p">];</span>
        <span class="p">[</span><span class="n">SQFetchCache</span> <span class="nf">setCache</span><span class="p">:</span><span class="n">responseObject</span> <span class="nf">key</span><span class="p">:</span><span class="n">URLString</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">failure</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">(</span><span class="n">responseObject</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">SQFetchSerialState</span><span class="p">)</span>
                <span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
        <span class="p">}</span>
        
    <span class="p">}];</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">SQFetchManager</span> <span class="o">*</span><span class="p">)</span><span class="n">managerWithState</span><span class="o">:</span><span class="p">(</span><span class="n">SQFetchState</span><span class="p">)</span><span class="n">state</span> <span class="p">{</span>
    <span class="n">SQFetchManager</span> <span class="o">*</span> <span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchManager</span> <span class="nf">new</span><span class="p">];</span>
    <span class="n">manager</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">manager</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>
<p>这个是整个实现文件, 可以看到, 这是如何使用<code class="highlighter-rouge">函数式编程</code>了, 用起来真是神清气爽, 但不知道如果别人用了会是什么感受…</p>

<p>如何实现同步依赖, 主要是使用了<code class="highlighter-rouge">信号量</code>, 配合<code class="highlighter-rouge">队列依赖</code>就可以实现啦~</p>

<h4 id="序列化">序列化</h4>

<p>序列化就是对不同的<code class="highlighter-rouge">请求</code>和<code class="highlighter-rouge">响应</code>做不同的解析.</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">SQFetchSerialization</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">getMethodSerializationWithParameters</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameters</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nf">postMethodSerializationWithParameters</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameters</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">serializationWithContentType</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">contentType</span> <span class="nf">data</span><span class="p">:(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre>
</div>
<p>看头文件也是简洁明了吧…</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "SQFetchSerialization.h"
#import &lt;UIKit/UIKit.h&gt;
</span>
<span class="k">@implementation</span> <span class="nc">SQFetchSerialization</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">getMethodSerializationWithParameters</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameters</span> <span class="p">{</span>
    
    <span class="n">NSMutableString</span> <span class="o">*</span> <span class="n">parameterString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="nf">string</span><span class="p">];</span>
    <span class="p">[</span><span class="n">parameters</span> <span class="nf">enumerateKeysAndObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="n">id</span>  <span class="n">_Nonnull</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BOOL</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
        <span class="p">[</span><span class="n">parameterString</span> <span class="nf">appendFormat</span><span class="p">:</span><span class="s">@"%@=%@&amp;"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">];</span>
    <span class="p">}];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameterString</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">parameterString</span> <span class="nf">insertString</span><span class="p">:</span><span class="s">@"?"</span> <span class="nf">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">[</span><span class="n">parameterString</span> <span class="nf">deleteCharactersInRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">parameterString</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">parameterString</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nf">postMethodSerializationWithParameters</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameters</span> <span class="p">{</span>
    
    <span class="n">NSMutableString</span> <span class="o">*</span> <span class="n">parameterString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="nf">string</span><span class="p">];</span>
    <span class="p">[</span><span class="n">parameters</span> <span class="nf">enumerateKeysAndObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="n">id</span>  <span class="n">_Nonnull</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BOOL</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
        <span class="p">[</span><span class="n">parameterString</span> <span class="nf">appendFormat</span><span class="p">:</span><span class="s">@"%@=%@&amp;"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">];</span>
    <span class="p">}];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameterString</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">parameterString</span> <span class="nf">deleteCharactersInRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">parameterString</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">parameterString</span> <span class="nf">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">serializationWithContentType</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">contentType</span> <span class="nf">data</span><span class="p">:(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
    
    <span class="n">id</span> <span class="n">responseObject</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">contentType</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="s">@"application/json"</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">responseObject</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nf">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span>
                                                         <span class="nf">options</span><span class="p">:</span><span class="n">NSJSONReadingMutableContainers</span> <span class="n">error</span><span class="o">:&amp;</span><span class="n">error</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">contentType</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="s">@"image/jpeg"</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">CGImageRef</span> <span class="n">cgImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span><span class="n">data</span><span class="p">].</span><span class="n">CGImage</span><span class="p">;</span>
        <span class="n">CGImageAlphaInfo</span> <span class="n">alphaInfo</span> <span class="o">=</span> <span class="n">CGImageGetAlphaInfo</span><span class="p">(</span><span class="n">cgImage</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">kCGBitmapAlphaInfoMask</span><span class="p">;</span>
        
        <span class="n">BOOL</span> <span class="n">hasAlpha</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alphaInfo</span> <span class="o">==</span> <span class="n">kCGImageAlphaPremultipliedLast</span> <span class="o">||</span>
            <span class="n">alphaInfo</span> <span class="o">==</span> <span class="n">kCGImageAlphaPremultipliedFirst</span> <span class="o">||</span>
            <span class="n">alphaInfo</span> <span class="o">==</span> <span class="n">kCGImageAlphaLast</span> <span class="o">||</span>
            <span class="n">alphaInfo</span> <span class="o">==</span> <span class="n">kCGImageAlphaFirst</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">hasAlpha</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">CGColorSpaceRef</span> <span class="n">colorSpace</span> <span class="o">=</span> <span class="n">CGColorSpaceCreateDeviceRGB</span><span class="p">();</span>
        <span class="n">CGBitmapInfo</span> <span class="n">bitmapInfo</span> <span class="o">=</span> <span class="n">kCGBitmapByteOrder32Host</span><span class="p">;</span>
        <span class="n">bitmapInfo</span> <span class="o">|=</span> <span class="n">hasAlpha</span> <span class="p">?</span> <span class="n">kCGImageAlphaPremultipliedFirst</span> <span class="p">:</span> <span class="n">kCGImageAlphaNoneSkipFirst</span><span class="p">;</span>
        
        <span class="kt">size_t</span> <span class="n">width</span> <span class="o">=</span> <span class="n">CGImageGetWidth</span><span class="p">(</span><span class="n">cgImage</span><span class="p">);</span>
        <span class="kt">size_t</span> <span class="n">height</span> <span class="o">=</span> <span class="n">CGImageGetHeight</span><span class="p">(</span><span class="n">cgImage</span><span class="p">);</span>
        
        <span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CGBitmapContextCreate</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colorSpace</span><span class="p">,</span> <span class="n">bitmapInfo</span><span class="p">);</span>
        <span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">cgImage</span><span class="p">);</span>
        <span class="n">cgImage</span> <span class="o">=</span> <span class="n">CGBitmapContextCreateImage</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        
        <span class="n">UIImage</span> <span class="o">*</span> <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithCGImage</span><span class="p">:</span><span class="n">cgImage</span><span class="p">];</span>
        <span class="n">CGColorSpaceRelease</span><span class="p">(</span><span class="n">colorSpace</span><span class="p">);</span>
        <span class="n">CGContextRelease</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="n">CGImageRelease</span><span class="p">(</span><span class="n">cgImage</span><span class="p">);</span>
        <span class="n">responseObject</span> <span class="o">=</span> <span class="n">image</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">responseObject</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p>相关实现也是对<code class="highlighter-rouge">请求参数进行拼接</code>, 以及<code class="highlighter-rouge">对响应的数据进行分类处理</code>…</p>

<h4 id="网络监测">网络监测</h4>

<p>这个依赖了<code class="highlighter-rouge">Apple</code>的<code class="highlighter-rouge">Reachability</code>就是作用网络不可用的时候, 不要尝试执行网络请求.</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "SQFetchReachability.h"
</span>
<span class="k">@interface</span> <span class="nc">SQFetchReachability</span><span class="p">()</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">Reachability</span> <span class="o">*</span> <span class="n">hostReachability</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">Reachability</span> <span class="o">*</span> <span class="n">routerReachability</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">SQFetchReachability</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">load</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">SQFetchReachability</span> <span class="nf">sharedInstance</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">sharedInstance</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">SQFetchReachability</span> <span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">super</span> <span class="nf">allocWithZone</span><span class="p">:</span><span class="nb">NULL</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">allocWithZone</span><span class="o">:</span><span class="p">(</span><span class="k">struct</span> <span class="n">_NSZone</span> <span class="o">*</span><span class="p">)</span><span class="n">zone</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nf">sharedInstance</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="nf">defaultCenter</span><span class="p">]</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span>
                                                 <span class="nf">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">appReachabilityChanged</span><span class="o">:</span><span class="p">)</span>
                                                     <span class="n">name</span><span class="o">:</span><span class="n">kReachabilityChangedNotification</span>
                                                   <span class="n">object</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">remoteHostName</span> <span class="o">=</span> <span class="s">@"www.baidu.com"</span><span class="p">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hostReachability</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reachability</span> <span class="nf">reachabilityWithHostName</span><span class="p">:</span><span class="n">remoteHostName</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">hostReachability</span> <span class="nf">startNotifier</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">routerReachability</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reachability</span> <span class="nf">reachabilityForInternetConnection</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">routerReachability</span> <span class="nf">startNotifier</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">appReachabilityChanged</span><span class="o">:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="n">notification</span><span class="p">{</span>
    <span class="n">Reachability</span> <span class="o">*</span> <span class="n">reach</span> <span class="o">=</span> <span class="p">[</span><span class="n">notification</span> <span class="nf">object</span><span class="p">];</span>
    <span class="k">if</span><span class="p">([</span><span class="n">reach</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">Reachability</span> <span class="nf">class</span><span class="p">]]){</span>
        <span class="n">NetworkStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">[</span><span class="n">reach</span> <span class="nf">currentReachabilityStatus</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reach</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">routerReachability</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NotReachable</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"routerReachability NotReachable"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ReachableViaWiFi</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"routerReachability ReachableViaWiFi"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ReachableViaWWAN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"routerReachability ReachableViaWWAN"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reach</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">hostReachability</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"hostReachability"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">reach</span> <span class="nf">currentReachabilityStatus</span><span class="p">]</span> <span class="o">==</span> <span class="n">NotReachable</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"hostReachability failed"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ReachableViaWiFi</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"hostReachability ReachableViaWiFi"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ReachableViaWWAN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"hostReachability ReachableViaWWAN"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<h4 id="二级缓存">二级缓存</h4>

<p>对于这块, 看过<code class="highlighter-rouge">SD</code>的同学肯定非常了解, <code class="highlighter-rouge">内存缓存</code>和<code class="highlighter-rouge">磁盘缓存</code>.</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "SQFetchCache.h"
#import &lt;CommonCrypto/CommonDigest.h&gt;
#import &lt;UIKit/UIKit.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">SQFetchCache</span><span class="p">()</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span> <span class="n">memoryCache</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">SQFetchCache</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">memoryCache</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_memoryCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_memoryCache</span> <span class="o">=</span> <span class="p">@{}.</span><span class="n">mutableCopy</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_memoryCache</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">sharedInstance</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">SQFetchCache</span> <span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">super</span> <span class="nf">allocWithZone</span><span class="p">:</span><span class="nb">NULL</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">allocWithZone</span><span class="o">:</span><span class="p">(</span><span class="k">struct</span> <span class="n">_NSZone</span> <span class="o">*</span><span class="p">)</span><span class="n">zone</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nf">sharedInstance</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setCache</span><span class="o">:</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">data</span> <span class="n">key</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">data</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">UIImage</span> <span class="nf">class</span><span class="p">]])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">SQFetchCache</span> <span class="nf">sharedInstance</span><span class="p">].</span><span class="n">memoryCache</span><span class="p">[[</span><span class="n">self</span> <span class="nf">__sha1</span><span class="p">:</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SQFetchCache</span> <span class="nf">__detectionDiskCache</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">homePath</span> <span class="o">=</span> <span class="n">NSHomeDirectory</span><span class="p">();</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">homePath</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@"Library/Caches"</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:[</span><span class="n">self</span> <span class="nf">__sha1</span><span class="p">:</span><span class="n">key</span><span class="p">]];</span>
        <span class="p">[</span><span class="n">UIImagePNGRepresentation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="nf">writeToFile</span><span class="p">:</span><span class="n">filePath</span> <span class="nf">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">getCacheFromKey</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span> <span class="p">{</span>
    <span class="n">id</span> <span class="n">cache</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQFetchCache</span> <span class="nf">sharedInstance</span><span class="p">].</span><span class="n">memoryCache</span><span class="p">[[</span><span class="n">self</span> <span class="nf">__sha1</span><span class="p">:</span><span class="n">key</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">cachePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSCachesDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">)</span> <span class="nf">lastObject</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@/%@"</span><span class="p">,</span> <span class="n">cachePath</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span> <span class="nf">__sha1</span><span class="p">:</span><span class="n">key</span><span class="p">]];</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImage</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">initWithContentsOfFile</span><span class="p">:</span><span class="n">file</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">cache</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">__detectionDiskCache</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSFileManager</span> <span class="o">*</span> <span class="n">fileManager</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSFileManager</span> <span class="nf">defaultManager</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">cachePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSCachesDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">)</span> <span class="nf">lastObject</span><span class="p">];</span>
        <span class="n">NSDirectoryEnumerator</span> <span class="o">*</span> <span class="n">direnum</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileManager</span> <span class="nf">enumeratorAtPath</span><span class="p">:</span><span class="n">cachePath</span><span class="p">];</span>
        <span class="n">NSError</span> <span class="o">*</span> <span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">filename</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="n">direnum</span> <span class="nf">nextObject</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">NSDictionary</span> <span class="o">*</span> <span class="n">fileAttributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileManager</span> <span class="nf">attributesOfItemAtPath</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@/%@"</span><span class="p">,</span><span class="n">cachePath</span><span class="p">,</span> <span class="n">filename</span><span class="p">]</span> <span class="nf">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fileAttributes</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSNumber</span> <span class="o">*</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileAttributes</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSFileSize</span><span class="p">];</span>
                <span class="n">NSString</span> <span class="o">*</span> <span class="n">fileOwner</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileAttributes</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSFileOwnerAccountName</span><span class="p">];</span>
                <span class="n">NSDate</span> <span class="o">*</span> <span class="n">fileModDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileAttributes</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSFileModificationDate</span><span class="p">];</span>
                <span class="n">NSDate</span> <span class="o">*</span> <span class="n">fileCreateDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileAttributes</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSFileCreationDate</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fileSize</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"File size: %qi</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">fileSize</span> <span class="nf">unsignedLongLongValue</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fileOwner</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Owner: %@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fileOwner</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fileModDate</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Modification date: %@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fileModDate</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fileCreateDate</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"create date:%@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fileModDate</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Path (%@) is invalid."</span><span class="p">,</span> <span class="n">cachePath</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">clearDiskCache</span> <span class="p">{</span>
    <span class="n">NSFileManager</span> <span class="o">*</span><span class="n">fileManager</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSFileManager</span> <span class="nf">defaultManager</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span> <span class="n">cachePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSCachesDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">)</span> <span class="nf">lastObject</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span><span class="n">cachePath</span><span class="p">);</span>
    <span class="n">NSDirectoryEnumerator</span> <span class="o">*</span> <span class="n">fileEnumerator</span> <span class="o">=</span> <span class="p">[</span><span class="n">fileManager</span> <span class="nf">enumeratorAtPath</span><span class="p">:</span><span class="n">cachePath</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span> <span class="n">fileName</span> <span class="k">in</span> <span class="n">fileEnumerator</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">cachePath</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="n">fileName</span><span class="p">];</span>
        <span class="p">[</span><span class="n">fileManager</span> <span class="nf">removeItemAtPath</span><span class="p">:</span><span class="n">filePath</span> <span class="nf">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">__sha1</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">inputString</span> <span class="p">{</span>
    <span class="n">NSData</span> <span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputString</span> <span class="nf">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">digest</span><span class="p">[</span><span class="nf">CC_SHA1_DIGEST_LENGTH</span><span class="p">];</span>
    <span class="n">CC_SHA1</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">bytes</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span><span class="n">digest</span><span class="p">);</span>
    <span class="n">NSMutableString</span> <span class="o">*</span><span class="n">outputString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="nf">stringWithCapacity</span><span class="p">:</span><span class="n">CC_SHA1_DIGEST_LENGTH</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CC_SHA1_DIGEST_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">outputString</span> <span class="nf">appendFormat</span><span class="p">:</span><span class="s">@"%02x"</span><span class="p">,</span><span class="n">digest</span><span class="p">[</span><span class="nf">i</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">outputString</span> <span class="nf">lowercaseString</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>
<p>如何优化就是对<code class="highlighter-rouge">空间和时间两方面</code>, 这里可以关注<code class="highlighter-rouge">__detectionDiskCache</code>这个方法中进行判断处理.. 可以策略性的进行删除..(<code class="highlighter-rouge">内存缓存</code>也是相同的思路)</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "UIImageView+SQFetcher.h"
#import "SQFetcher.h"
</span>
<span class="k">@implementation</span> <span class="nc">UIImageView</span> <span class="p">(</span><span class="nl">SQFetcher</span><span class="p">)</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sq_imageWithURLString</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">URLString</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">SQFetchManager</span> <span class="nf">managerWithState</span><span class="p">:</span><span class="n">SQFetchConcurrentState</span><span class="p">]</span>
    <span class="p">.</span><span class="n">GET</span><span class="p">(</span><span class="n">URLString</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">){</span>
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="n">self</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">responseObject</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">},</span><span class="nb">nil</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>
<p>分类使用的实现也是非常简单的, 我么使用起来也是非常方便.</p>

<h4 id="最后">最后</h4>

<p>这个仅仅是一个<code class="highlighter-rouge">最小可用</code>的设计, 当然还有很多值得优化的点, 比如<code class="highlighter-rouge">配置请求头</code>, <code class="highlighter-rouge">请求复用</code>, <code class="highlighter-rouge">哈希桶扩张</code>, <code class="highlighter-rouge">管道</code>, 对于需求, 还要<code class="highlighter-rouge">安全验证</code>等, 写这个东西其实就是了解下一个网络框架需要了解点什么, 平时使用的时候<code class="highlighter-rouge">AFN</code>和<code class="highlighter-rouge">SD</code>肯定是你首选的方案!! 但有了这些思路, 你也可以实现一个自己定制的网络框架!</p>

<p>最后 本文中所有的源码都可以在github上找到 -&gt; <a href="https://github.com/coderZsq/coderZsq.project.ios/tree/master/SQPerformance">SQPerformance</a></p>
<blockquote>
  <p>GitHub Repo：<a href="https://github.com/coderZsq/coderZsq.project.ios">coderZsq.project.ios</a>
<br />Follow: <a href="https://github.com/coderZsq">coderZsq · GitHub</a>
<br />Resume: <a href="https://coderzsq.github.io/coderZsq.practice.web/">https://coderzsq.github.io/coderZsq.practice.web/</a></p>
</blockquote>

  </section>
</article>

<section class="read-more">
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">最近的文章</span>
       <h2 class="post-list__post-title post-title"><a href="/2019/01/iOS-%E5%BC%80%E5%8F%91%E8%80%85%E8%AF%A5%E8%AE%A4%E7%9C%9F%E6%80%9D%E8%80%83%E7%9A%84-%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98/" title="link to iOS 开发者该认真思考的「三个问题」">iOS 开发者该认真思考的「三个问题」</a></h2>
       <p class="excerpt">  GitHub Repo：coderZsq.project.iosFollow: coderZsq · GitHubResume: https://coderzsq.github.io/coderZsq.practice.web/日常扯淡大半年没有更新文章了, 可能是对自己写的内容有要求吧, 不想写一些如OC底层, 逆向入门这些像内容洗稿,东拼西凑的伪原创, 修修改改换换顺序就又是一篇完全没有意义的文章. 如果你获取技术大部分的手段是看技术博客的话, 是的, 是时候调整你的视角, 扩展你...&hellip;</p>
       <div class="post-list__meta"><time datetime="2019-01-10 17:00:00 +0800" class="post-list__meta--date date">2019-01-10</time> &#8226; <span class="post-list__meta--tags tags">移动开发</span><a class="btn-border-small" href=/2019/01/iOS-%E5%BC%80%E5%8F%91%E8%80%85%E8%AF%A5%E8%AE%A4%E7%9C%9F%E6%80%9D%E8%80%83%E7%9A%84-%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98/>继续阅读</a></div>
   </div>
   
   
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">更早的文章</span>
       <h2 class="post-list__post-title post-title"><a href="/2018/07/iOS-%E7%95%8C%E9%9D%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%B5%85%E6%9E%90/" title="link to iOS 界面性能优化浅析">iOS 界面性能优化浅析</a></h2>
       <p class="excerpt">  GitHub Repo：coderZsq.project.iosFollow: coderZsq · GitHubResume: https://coderzsq.github.io/coderZsq.practice.web/日常扯淡emm~~~ 前段时间又出去看了看iOS市场的行情, 除非是BAT, TMD, 这类一线的知名企业, 其他的只要努努力还是可以通过的, 这里分享一些小技巧, 比如当HR,或者别人内推你的时候, 不管要求写的多么的天花乱坠, 千万不要被这些东西给吓到了, ...&hellip;</p>
       <div class="post-list__meta"><time datetime="2018-07-08 14:30:00 +0800" class="post-list__meta--date date">2018-07-08</time> &#8226; <span class="post-list__meta--tags tags">移动开发</span><a class="btn-border-small" href=/2018/07/iOS-%E7%95%8C%E9%9D%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%B5%85%E6%9E%90/>继续阅读</a></div>
   </div>
   
</section>

<section class="post-comments">
  
  
  
  
</section>


            <section class="footer">
    <footer>
    	<span class="footer__copyright">本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a></span>
        <span class="footer__copyright">由 <a href="https://jekyllrb.com">Jekyll</a> 于 2020-09-16 生成，感谢 <a href="https://www.digitalocean.com/?refcode=30ed2d146762">Digital Ocean</a> 为本站提供稳定的 VPS 服务</span>
        <span class="footer__copyright">本站由 <a href="https://github.com/coderZsq">@Castie!</a> 创建，采用 <a href="https://github.com/onevcat/vno-jekyll">Vno - Jekyll</a> 作为主题，您可以在 GitHub 找到<a href="https://github.com/onevcat/OneV-s-Den">本站源码</a> - &copy; 2020</span>
    </footer>
</section>

        </div>
    </div>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>

<script type="text/javascript" src="/js/main.js"></script>



    
  </body>

</html>
